<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAMCIS AI â€” Gantt Chart</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg: #0d1018;
    --surface: #141824;
    --surface2: #1a2030;
    --surface3: #1f2640;
    --border: #252d42;
    --border2: #2e3850;
    --text: #dde2f0;
    --text-muted: #5a6285;
    --text-dim: #8892b0;
    --accent: #4f6ef7;
    --danger: #f87171;
    --row-h: 36px;
    --label-w: 360px;
    --header-h: 60px;
  }

  /* â”€â”€ LIGHT MODE â”€â”€ */
  body.light {
    --bg: #f4f6fb;
    --surface: #ffffff;
    --surface2: #eef1f8;
    --surface3: #e2e7f4;
    --border: #d5daea;
    --border2: #b8c2d8;
    --text: #1a2040;
    --text-muted: #7a85aa;
    --text-dim: #4a5278;
    --accent: #3a5ce6;
    --danger: #dc2626;
  }
  body.light #json-editor { background: #f8f9fc; color: #1a6b3a; }
  body.light ::-webkit-scrollbar-track { background: #eef1f8; }
  body.light ::-webkit-scrollbar-thumb { background: #c8cedf; }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100vh;
  }

  /* â”€â”€ TOPBAR â”€â”€ */
  .topbar {
    padding: 10px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 14px;
    flex-wrap: wrap;
    flex-shrink: 0;
  }
  .topbar-title h1 { font-size: 17px; font-weight: 800; letter-spacing: -0.3px; color: var(--text); line-height: 1; }
  .topbar-title h1 span { color: var(--accent); }
  .topbar-title .subtitle { font-size: 9px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-top: 3px; }
  .topbar-pills { display: flex; gap: 6px; flex-wrap: wrap; flex: 1; }
  .pill { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text-muted); white-space: nowrap; }
  .pill b { color: var(--text); font-weight: 500; }
  .pill.highlight { border-color: var(--accent); }
  .pill.highlight b { color: var(--accent); }
  .topbar-actions { display: flex; gap: 7px; }
  .btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 13px; border-radius: 7px; font-size: 12px; font-weight: 700; font-family: 'Syne', sans-serif; cursor: pointer; border: none; transition: filter .15s, background .15s; }
  .btn:hover { filter: brightness(1.15); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-ghost { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); }
  .btn-ghost.active { background: var(--surface3); border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ SCENARIO BAR â”€â”€ */
  .scenario-bar {
    display: flex;
    align-items: stretch;
    background: var(--surface);
    border-bottom: 2px solid var(--border2);
    flex-shrink: 0;
    overflow-x: auto;
  }
  .scenario-bar-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    padding: 0 16px;
    display: flex;
    align-items: center;
    border-right: 1px solid var(--border);
    white-space: nowrap;
    flex-shrink: 0;
  }
  .scenario-tab {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 9px 40px 9px 16px;
    cursor: pointer;
    border-right: 1px solid var(--border);
    border-bottom: 3px solid transparent;
    transition: background .15s, border-color .15s;
    min-width: 210px;
    user-select: none;
    flex-shrink: 0;
  }
  .scenario-tab:hover { background: var(--surface2); }
  .scenario-tab.active { background: var(--surface2); border-bottom-color: var(--accent); }
  .sc-letter { font-size: 9px; font-weight: 800; font-family: 'DM Mono', monospace; letter-spacing: 1px; margin-bottom: 1px; }
  .scenario-tab.active .sc-letter { color: var(--accent); }
  .scenario-tab:not(.active) .sc-letter { color: var(--text-muted); }
  .sc-name { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .scenario-tab.active .sc-name { color: var(--text); }
  .scenario-tab:not(.active) .sc-name { color: var(--text-muted); }
  .sc-subtitle { font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
  .sc-meta { font-size: 9px; color: var(--text-muted); font-family: 'DM Mono', monospace; margin-top: 3px; white-space: nowrap; }
  .scenario-tab.active .sc-meta { color: var(--text-dim); }
  .sc-badge {
    position: absolute;
    top: 8px; right: 8px;
    font-size: 8px; font-weight: 700;
    padding: 2px 5px; border-radius: 3px;
    letter-spacing: 0.5px; white-space: nowrap;
  }

  /* â”€â”€ GROUP CONTROLS â”€â”€ */
  .controls { padding: 7px 20px; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; background: var(--bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .ctrl-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-right: 4px; flex-shrink: 0; }
  .group-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 20px; border: 1.5px solid; cursor: pointer; font-size: 11px; font-weight: 600; transition: opacity .2s, background .2s; user-select: none; white-space: nowrap; }
  .group-toggle.off { opacity: 0.28; background: transparent !important; }
  .group-toggle .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

  /* â”€â”€ ADD BAR â”€â”€ */
  .add-bar { padding: 7px 20px; display: flex; gap: 7px; flex-wrap: wrap; align-items: center; background: var(--bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .add-bar input, .add-bar select { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 5px 9px; font-size: 11px; font-family: 'DM Mono', monospace; outline: none; transition: border-color .2s; }
  .add-bar input:focus, .add-bar select:focus { border-color: var(--accent); }
  .add-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); flex-shrink: 0; }

  /* â”€â”€ JSON PANEL â”€â”€ */
  .json-panel { background: var(--surface); border-bottom: 1px solid var(--border); display: none; flex-direction: column; flex-shrink: 0; max-height: 360px; }
  .json-panel.open { display: flex; }
  .json-panel-hdr { padding: 9px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .json-panel-hdr span { flex: 1; font-size: 11px; color: var(--text-muted); font-family: 'DM Mono', monospace; }
  .json-err { padding: 5px 20px; font-size: 11px; font-family: 'DM Mono', monospace; color: var(--danger); background: #2a1010; display: none; flex-shrink: 0; }
  .json-err.show { display: block; }
  #json-editor { flex: 1; background: #090c12; color: #7ec897; border: none; padding: 14px 20px; font-family: 'DM Mono', monospace; font-size: 11px; line-height: 1.75; resize: none; outline: none; overflow-y: auto; tab-size: 2; }

  /* â”€â”€ GANTT â”€â”€ */
  .gantt-scroll { flex: 1; overflow: auto; position: relative; }
  .gantt-inner { min-width: 960px; display: flex; flex-direction: column; min-height: 100%; }

  .gantt-header { display: flex; position: sticky; top: 0; z-index: 30; }
  .g-label-hdr { width: var(--label-w); min-width: var(--label-w); height: var(--header-h); background: var(--surface); border: 1px solid var(--border); border-right: 2px solid var(--border2); padding: 0 14px; display: flex; align-items: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); position: sticky; left: 0; z-index: 31; }
  .g-timeline-hdr { flex: 1; height: var(--header-h); background: var(--surface); border: 1px solid var(--border); border-left: none; overflow: hidden; display: flex; flex-direction: column; }
  .g-quarters { display: flex; height: 24px; border-bottom: 1px solid var(--border); }
  .g-quarter { display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); border-right: 1px solid var(--border); }
  .g-quarter:last-child { border-right: none; }
  .g-months { display: flex; flex: 1; }
  .g-month { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; letter-spacing: 0.8px; color: var(--text-muted); border-right: 1px solid var(--border); text-transform: uppercase; }
  .g-month:last-child { border-right: none; }

  .gantt-body { position: relative; flex: 1; }

  .group-hdr-row { display: flex; height: 38px; border-top: 2px solid var(--border2); }
  .group-hdr-lbl { width: var(--label-w); min-width: var(--label-w); background: var(--surface2); border-right: 2px solid var(--border2); padding: 0 14px; display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; position: sticky; left: 0; z-index: 11; }
  .gcolor { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
  .g-meta { margin-left: auto; font-weight: 400; font-size: 9px; color: var(--text-muted); font-family: 'DM Mono', monospace; white-space: nowrap; }
  .group-hdr-tl { flex: 1; background: var(--surface2); position: relative; overflow: hidden; }
  .group-tint { position: absolute; inset: 0; opacity: 0.05; }

  .task-row { display: flex; height: var(--row-h); border-top: 1px solid var(--border); }
  .task-row:hover .task-lbl { background: var(--surface2); }

  .task-lbl { width: var(--label-w); min-width: var(--label-w); padding: 0 10px 0 14px; display: flex; align-items: center; gap: 6px; border-right: 2px solid var(--border2); background: var(--bg); transition: background .12s; position: sticky; left: 0; z-index: 10; }
  .task-id-badge { font-size: 9px; font-family: 'DM Mono', monospace; color: var(--text-muted); min-width: 20px; flex-shrink: 0; }
  .task-nm { flex: 1; font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .task-ref { font-size: 8px; color: var(--accent); font-family: 'DM Mono', monospace; background: var(--surface3); border: 1px solid var(--border2); border-radius: 3px; padding: 1px 4px; flex-shrink: 0; white-space: nowrap; }
  .task-dur-lbl { font-size: 9px; color: var(--text-muted); font-family: 'DM Mono', monospace; white-space: nowrap; flex-shrink: 0; }
  .task-del { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 11px; padding: 0 2px; opacity: 0; transition: opacity .12s, color .12s; flex-shrink: 0; }
  .task-row:hover .task-del { opacity: 1; }
  .task-del:hover { color: var(--danger); }

  .task-tl { flex: 1; position: relative; overflow: hidden; }
  .grid-ov { position: absolute; inset: 0; display: flex; pointer-events: none; }
  .grid-col { flex: 1; border-right: 1px solid var(--border); opacity: 0.35; }
  .grid-col:last-child { border-right: none; }

  .task-bar { position: absolute; height: 20px; top: 50%; transform: translateY(-50%); border-radius: 4px; cursor: pointer; transition: filter .12s; display: flex; align-items: center; padding: 0 6px; overflow: hidden; min-width: 4px; }
  .task-bar:hover { filter: brightness(1.3); }
  .bar-txt { font-size: 10px; font-weight: 600; color: rgba(0,0,0,0.72); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.1px; }

  .borrowed-badge { font-size: 8px; color: var(--accent); background: var(--surface3); border: 1px solid var(--accent); border-radius: 3px; padding: 1px 4px; flex-shrink: 0; }

  /* â”€â”€ OUTCOMES BANNER â”€â”€ */
  .outcomes-bar {
    padding: 8px 20px;
    background: var(--surface);
    border-bottom: 2px solid var(--border2);
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
    flex-wrap: wrap;
  }
  .outcomes-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    flex-shrink: 0;
    margin-right: 4px;
  }
  .outcome-card {
    display: flex;
    flex-direction: column;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 14px;
    min-width: 160px;
    position: relative;
    overflow: hidden;
    transition: border-color .2s;
  }
  .outcome-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    border-radius: 8px 0 0 8px;
  }
  .outcome-card .oc-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-bottom: 3px;
    white-space: nowrap;
  }
  .outcome-card .oc-value {
    font-size: 20px;
    font-weight: 800;
    line-height: 1;
    letter-spacing: -0.5px;
  }
  .outcome-card .oc-unit {
    font-size: 10px;
    font-weight: 400;
    color: var(--text-dim);
    margin-left: 3px;
  }
  .outcome-card .oc-note {
    font-size: 8px;
    color: var(--text-muted);
    margin-top: 3px;
    font-family: 'DM Mono', monospace;
  }

  /* tooltip outcome rows */
  .tt-outcomes { margin-top: 8px; }
  .tt-outcomes b { font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); display: block; margin-bottom: 3px; }
  .tt-oc-row { display: flex; justify-content: space-between; gap: 12px; font-size: 10px; color: var(--text-muted); margin-top: 3px; }
  .tt-oc-row span:last-child { color: var(--text); font-family: 'DM Mono', monospace; font-weight: 600; }

  #dep-svg { position: absolute; inset: 0; pointer-events: none; z-index: 5; overflow: visible; }

  /* â”€â”€ TOOLTIP â”€â”€ */
  .tooltip { position: fixed; background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px; padding: 12px 16px; pointer-events: none; z-index: 9999; opacity: 0; transition: opacity .1s; min-width: 240px; box-shadow: 0 12px 40px rgba(0,0,0,0.65); }
  .tooltip.show { opacity: 1; }
  .tt-name { font-size: 13px; font-weight: 700; margin-bottom: 9px; line-height: 1.3; }
  .tt-row { display: flex; justify-content: space-between; gap: 18px; margin-top: 5px; color: var(--text-muted); font-size: 11px; }
  .tt-row span:last-child { color: var(--text); font-family: 'DM Mono', monospace; text-align: right; }
  .tt-section { margin-top: 9px; font-size: 10px; line-height: 1.7; color: var(--text-muted); }
  .tt-section b { color: var(--text-dim); display: block; margin-bottom: 2px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; }
  .tt-ref-tag { display: inline-block; color: var(--accent); font-family: 'DM Mono', monospace; background: var(--surface3); border: 1px solid var(--border2); border-radius: 3px; padding: 1px 6px; font-size: 10px; }

  .empty { padding: 60px; text-align: center; color: var(--text-muted); font-size: 13px; }

  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€ PRINT INFO BLOCK (hidden on screen) â”€â”€ */
  .bar-print-info { display: none; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PRINT â€” uses body.printing class added by JS in beforeprint.
     Strategy: keep position:absolute on bars (so left/width % stay
     accurate for time alignment), but JS measures each bar's natural
     content height at a fixed pixel width, then sets that height on
     both the bar and the .task-tl so the row expands to fit.
     Grid lines are kept so time columns remain readable.
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  body.printing {
    --bg: #ffffff !important;
    --surface: #ffffff !important;
    --surface2: #f2f4f8 !important;
    --surface3: #e8ecf4 !important;
    --border: #d0d5e8 !important;
    --border2: #b0b8d0 !important;
    --text: #111827 !important;
    --text-muted: #6b7280 !important;
    --text-dim: #374151 !important;
    --accent: #2563eb !important;
    --label-w: 52px !important;
    background: #fff !important;
    color: #111827 !important;
    height: auto !important;
    overflow: visible !important;
  }

  /* Un-clip scroll containers */
  body.printing .gantt-scroll,
  body.printing .gantt-inner,
  body.printing .gantt-body {
    overflow: visible !important;
    height: auto !important;
    max-height: none !important;
    flex-shrink: 0 !important;
  }
  body.printing .gantt-scroll { flex: none !important; }

  /* De-sticky headers */
  body.printing .gantt-header,
  body.printing .g-label-hdr,
  body.printing .task-lbl,
  body.printing .group-hdr-lbl { position: static !important; }

  /* Hide interactive chrome */
  body.printing .topbar-actions,
  body.printing .scenario-bar,
  body.printing .controls,
  body.printing .add-bar,
  body.printing .json-panel,
  body.printing .tooltip,
  body.printing .task-del,
  body.printing .borrowed-badge,
  body.printing #dep-svg { display: none !important; }

  /* Outcomes bar: keep it in print, but compact */
  body.printing .outcomes-bar {
    padding: 5px 14px !important;
    gap: 8px !important;
    background: #fff !important;
    border-bottom: 1px solid #b0b8d0 !important;
  }
  body.printing .outcome-card {
    padding: 4px 10px !important;
    min-width: 120px !important;
    background: #f2f4f8 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  body.printing .outcome-card .oc-value { font-size: 14px !important; color: #111 !important; }
  body.printing .outcome-card .oc-unit  { font-size: 8px !important;  color: #555 !important; }
  body.printing .outcome-card .oc-label { color: #555 !important; }
  body.printing .outcome-card .oc-note  { color: #888 !important; }
  body.printing .outcome-card::before { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

  /* bpi-outcomes in print cards */
  body.printing .bpi-outcomes {
    margin-top: 2px !important;
    border-top: 1px solid rgba(255,255,255,0.25) !important;
    padding-top: 2px !important;
  }
  body.printing .bpi-oc-row {
    font-size: 6px !important;
    color: rgba(255,255,255,0.85) !important;
    font-family: 'DM Mono', monospace !important;
    line-height: 1.4 !important;
    display: flex !important;
    justify-content: space-between !important;
    gap: 6px !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Topbar */
  body.printing .topbar {
    padding: 6px 14px !important;
    border-bottom: 2px solid #111 !important;
    background: #fff !important;
    margin-bottom: 4px !important;
  }
  body.printing .topbar-title h1 { font-size: 13px !important; color: #111 !important; }
  body.printing .topbar-title h1 span { color: #2563eb !important; }
  body.printing .topbar-title .subtitle { color: #666 !important; }
  body.printing .topbar-pills .pill { background: #f2f4f8 !important; border-color: #ccc !important; color: #444 !important; }
  body.printing .topbar-pills .pill b { color: #111 !important; }
  body.printing .topbar-pills .pill.highlight { border-color: #2563eb !important; }
  body.printing .topbar-pills .pill.highlight b { color: #2563eb !important; }

  /* Group rows */
  body.printing .group-hdr-row { background: #f2f4f8 !important; }
  body.printing .group-hdr-lbl { background: #f2f4f8 !important; color: #111 !important; }

  /* Task rows â€” height is set explicitly by JS to match bar content */
  body.printing .task-row {
    display: flex !important;
    align-items: stretch !important;
    border-top: 1px solid #d0d5e8 !important;
    /* height is set inline by JS */
  }

  /* Left label: slim column, just #id and Â§ref */
  body.printing .task-lbl {
    background: #fff !important;
    padding: 4px 5px !important;
    align-items: flex-start !important;
    flex-direction: column !important;
    justify-content: flex-start !important;
    gap: 2px !important;
    border-right: 2px solid #b0b8d0 !important;
    width: 52px !important;
    min-width: 52px !important;
    /* height matches row â€” set by JS */
  }
  body.printing .task-lbl .task-nm,
  body.printing .task-lbl .task-dur-lbl { display: none !important; }
  body.printing .task-lbl .task-id-badge { font-size: 9px !important; font-weight: 700 !important; color: #374151 !important; }
  body.printing .task-lbl .task-ref { font-size: 7px !important; color: #2563eb !important; background: #eef2ff !important; border-color: #c7d2fe !important; }

  /* Timeline cell â€” keep relative positioning so absolute bars work */
  body.printing .task-tl {
    overflow: visible !important;
    position: relative !important;
    /* height is set inline by JS */
  }

  /* Grid lines â€” keep them so months are readable, but lighter */
  body.printing .grid-ov { display: flex !important; position: absolute !important; inset: 0 !important; pointer-events: none !important; }
  body.printing .grid-col { border-right: 1px dashed #c8d0e8 !important; opacity: 1 !important; }

  /* Task bar â€” stays position:absolute (left/width % preserved for time).
     height is set inline by JS. Show rich info block. */
  body.printing .task-bar {
    top: 4px !important;
    /* left & width kept from inline style â€” NOT overridden */
    transform: none !important;
    /* height set by JS */
    align-items: flex-start !important;
    padding: 5px 7px !important;
    border-radius: 4px !important;
    overflow: hidden !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  body.printing .bar-txt { display: none !important; }

  body.printing .bar-print-info {
    display: flex !important;
    flex-direction: column !important;
    gap: 2px !important;
    width: 100% !important;
    overflow: hidden !important;
  }
  body.printing .bar-print-info .bpi-name {
    font-size: 8px !important; font-weight: 700 !important; color: #fff !important;
    line-height: 1.25 !important; white-space: normal !important; word-break: break-word !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
  }
  body.printing .bar-print-info .bpi-ref {
    font-size: 6.5px !important; font-weight: 600 !important;
    color: rgba(255,255,255,0.9) !important; background: rgba(0,0,0,0.2) !important;
    border-radius: 2px !important; padding: 1px 3px !important;
    display: inline-block !important; width: fit-content !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
  }
  body.printing .bar-print-info .bpi-dates {
    font-size: 6.5px !important; color: rgba(255,255,255,0.9) !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
  }
  body.printing .bar-print-info .bpi-budget {
    font-size: 7px !important; font-weight: 700 !important; color: #fff !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
  }
  body.printing .bar-print-info .bpi-deps {
    font-size: 6px !important; color: rgba(255,255,255,0.72) !important;
    white-space: normal !important; word-break: break-word !important; line-height: 1.35 !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
  }

  /* Header */
  body.printing .g-label-hdr { color: #6b7280 !important; background: #fff !important; width: 52px !important; min-width: 52px !important; }
  body.printing .g-quarter { color: #2563eb !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body.printing .g-month   { color: #4b5563 !important; }

  @media print {
    body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    @page { size: A3 landscape; margin: 10mm 8mm; }
  }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-title">
    <h1>CAMCIS <span>AI</span></h1>
    <div class="subtitle">Plan de mise en Å“uvre â€” Gantt interactif</div>
  </div>
  <div class="topbar-pills">
    <div class="pill highlight">ScÃ©nario: <b id="sum-scenario">â€”</b></div>
    <div class="pill">DurÃ©e: <b id="sum-dur">â€”</b></div>
    <div class="pill">Budget: <b id="sum-bud">â€”</b></div>
    <div class="pill">TÃ¢ches: <b id="sum-tasks">â€”</b></div>
    <div class="pill">Groupes: <b id="sum-groups">â€”</b></div>
  </div>
  <div class="topbar-actions">
    <button class="btn btn-ghost" id="theme-btn" onclick="toggleTheme()" title="Basculer jour/nuit">ğŸŒ™</button>
    <button class="btn btn-ghost" onclick="prepareForPrint();window.print();" title="Imprimer">ğŸ–¨ Imprimer</button>
    <button class="btn btn-ghost" id="json-btn" onclick="toggleJson()">{ } JSON</button>
    <button class="btn btn-ghost" onclick="addGroup()">+ Groupe</button>
  </div>
</div>

<!-- SCENARIO TABS -->
<div class="scenario-bar" id="scenario-bar"></div>

<!-- OUTCOMES BANNER -->
<div class="outcomes-bar" id="outcomes-bar"></div>

<!-- GROUP TOGGLES -->
<div class="controls" id="group-controls"></div>

<!-- ADD BAR -->
<div class="add-bar">
  <span class="add-label">Ajouter :</span>
  <input type="text"   id="inp-name"   placeholder="Nom de la tÃ¢che" style="width:155px;" />
  <select id="inp-group" style="width:155px;"></select>
  <input type="number" id="inp-start"  placeholder="Mois dÃ©but" min="1" style="width:85px;" />
  <input type="number" id="inp-dur"    placeholder="DurÃ©e (mois)" min="1" style="width:90px;" />
  <input type="number" id="inp-budget" placeholder="Budget FCFA" min="0" style="width:120px;" />
  <input type="text"   id="inp-deps"   placeholder="DÃ©p. IDs: 1,3" style="width:110px;" />
  <input type="text"   id="inp-ref"    placeholder="RÃ©f. Â§2.1" style="width:80px;" />
  <button class="btn btn-primary" onclick="addTask()">+ Ajouter</button>
</div>

<!-- JSON PANEL -->
<div class="json-panel" id="json-panel">
  <div class="json-panel-hdr">
    <span>// Modifiez le JSON puis appliquez â€” Ctrl+S pour sauvegarder</span>
    <button class="btn btn-ghost" onclick="applyJson()" style="font-size:11px;padding:5px 11px;">âœ“ Appliquer</button>
    <button class="btn btn-ghost" onclick="toggleJson()" style="font-size:11px;padding:5px 11px;">âœ•</button>
  </div>
  <div class="json-err" id="json-err"></div>
  <textarea id="json-editor" spellcheck="false"></textarea>
</div>

<!-- GANTT -->
<div class="gantt-scroll" id="gantt-scroll">
  <div class="gantt-inner" id="gantt-inner">
    <div class="gantt-header">
      <div class="g-label-hdr">TÃ¢ches / Groupes</div>
      <div class="g-timeline-hdr">
        <div class="g-quarters" id="g-quarters"></div>
        <div class="g-months"   id="g-months"></div>
      </div>
    </div>
    <div class="gantt-body" id="gantt-body">
      <svg id="dep-svg"></svg>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PALETTE & SCENARIO BADGE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PALETTE = ['#4f9ef8','#f77f5f','#50d08c','#a78bfa','#f9c74f','#38bdf8','#fb923c','#f472b6','#34d399','#e879f9'];

const SC_BADGE = {
  A: { label:'SOCLE',        bg:'#1a2840', c:'#4f9ef8' },
  B: { label:'OPÃ‰RATIONNEL', bg:'#1a2e20', c:'#50d08c' },
  C: { label:'INTÃ‰GRAL',     bg:'#2e1a1a', c:'#f77f5f' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROJECT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let project = {
  name: "CAMCIS AI â€” Plan de mise en Å“uvre",
  timeUnit: "mois",
  budgetUnit: "FCFA",
  startDate: "2025-01-01",

  activeScenario: "A",

  // â”€â”€ 4 SCENARIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // A  Socle minimal       : gouvernance + data warehouse fondation seulement
  // B  DÃ©ploiement core    : A + recette douaniÃ¨re + performance opÃ©rationnelle
  // C  Extension IA        : B + dÃ©tection fraudes + service usagers
  // D  Programme intÃ©gral  : tout, y compris MDM & conformitÃ© avancÃ©e
  scenarios: [
    {
      id: "A",
      label: "ScÃ©nario A",
      name: "Socle minimal",
      subtitle: "Gouvernance & fondation data uniquement",
      taskIds: [21, 22, 25, 26, 27, 28, 29, 30]
    },
    {
      id: "B",
      label: "ScÃ©nario B",
      name: "DÃ©ploiement opÃ©rationnel",
      subtitle: "Recette douaniÃ¨re + performance + infrastructure",
      taskIds: [1, 2, 3, 4, 5, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]
    },
    {
      id: "C",
      label: "ScÃ©nario C",
      name: "Programme intÃ©gral",
      subtitle: "Tous modules â€” IA, fraudes, usagers, MDM & conformitÃ©",
      taskIds: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]
    }
  ],

  // â”€â”€ OUTCOME DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Each outcome has: id, label, unit, color, icon
  // Task contributions are summed across all visible tasks.
  outcomes: [
    { id:"recettes",  label:"AmÃ©lioration des recettes",      unit:"%",    color:"#50d08c", icon:"ğŸ“ˆ" },
    { id:"charge",    label:"RÃ©duction de la charge",         unit:"h/an", color:"#4f9ef8", icon:"â±" },
    { id:"transit",   label:"Baisse durÃ©e de transit",        unit:"%",    color:"#a78bfa", icon:"ğŸšš" }
  ],

  // â”€â”€ GROUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  groups: [
    { id:1, name:"AmÃ©lioration recette douaniÃ¨re",    color:"#4f9ef8", visible:true },
    { id:2, name:"DÃ©tection des fraudes",             color:"#f77f5f", visible:true },
    { id:3, name:"Service usagers",                   color:"#50d08c", visible:true },
    { id:4, name:"Performance opÃ©rationnelle",        color:"#a78bfa", visible:true },
    { id:5, name:"Services communs & Data Warehouse", color:"#f9c74f", visible:true },
    { id:6, name:"Gouvernance & Change Management",   color:"#38bdf8", visible:true }
  ],

  // â”€â”€ TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ref = chapter reference in the project document
  // outcomes = { recettes: %, charge: h/an, transit: % }
  tasks: [
    // â”€â”€ G1 Recette douaniÃ¨re â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id: 1,  groupId:1, name:"Audit des processus dÃ©claratifs",          start:1,  duration:2, budget:45000000,   deps:[],        ref:"Â§ 2.1", outcomes:{recettes:0,   charge:200,  transit:0  } },
    { id: 2,  groupId:1, name:"ModÃ¨le IA â€” Ã©valuation risque fiscal",     start:3,  duration:4, budget:130000000,  deps:[1,22],    ref:"Â§ 2.2", outcomes:{recettes:4.5, charge:1200, transit:0  } },
    { id: 3,  groupId:1, name:"IntÃ©gration valorisation tarifaire",       start:7,  duration:4, budget:200000000,  deps:[2],       ref:"Â§ 2.3", outcomes:{recettes:6.0, charge:800,  transit:0  } },
    { id: 4,  groupId:1, name:"Tableau de bord recette temps rÃ©el",       start:10, duration:3, budget:85000000,   deps:[3,23],    ref:"Â§ 2.4", outcomes:{recettes:1.5, charge:400,  transit:0  } },
    { id: 5,  groupId:1, name:"Formation agents â€” Ã©valuation IA",         start:12, duration:2, budget:30000000,   deps:[4],       ref:"Â§ 2.5", outcomes:{recettes:0.5, charge:300,  transit:0  } },

    // â”€â”€ G2 DÃ©tection fraudes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id: 6,  groupId:2, name:"Collecte & Ã©tiquetage donnÃ©es fraudes",    start:1,  duration:3, budget:60000000,   deps:[],        ref:"Â§ 3.1", outcomes:{recettes:0,   charge:150,  transit:0  } },
    { id: 7,  groupId:2, name:"ModÃ¨le ML â€” dÃ©tection anomalies",          start:4,  duration:5, budget:185000000,  deps:[6,22],    ref:"Â§ 3.2", outcomes:{recettes:3.0, charge:900,  transit:0  } },
    { id: 8,  groupId:2, name:"SystÃ¨me d'alerte temps rÃ©el",              start:9,  duration:3, budget:140000000,  deps:[7],       ref:"Â§ 3.3", outcomes:{recettes:2.0, charge:600,  transit:0  } },
    { id: 9,  groupId:2, name:"Dashboard enquÃªteurs / cas fraude",        start:11, duration:3, budget:90000000,   deps:[8,23],    ref:"Â§ 3.4", outcomes:{recettes:1.0, charge:500,  transit:0  } },
    { id:10,  groupId:2, name:"Audit & validation modÃ¨le anti-fraude",    start:13, duration:2, budget:50000000,   deps:[9],       ref:"Â§ 3.5", outcomes:{recettes:0.5, charge:200,  transit:0  } },

    // â”€â”€ G3 Service usagers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:11,  groupId:3, name:"Ã‰tude UX & cartographie parcours",         start:2,  duration:2, budget:35000000,   deps:[],        ref:"Â§ 4.1", outcomes:{recettes:0,   charge:100,  transit:0.5} },
    { id:12,  groupId:3, name:"Refonte portail usagers",                  start:4,  duration:4, budget:110000000,  deps:[11],      ref:"Â§ 4.2", outcomes:{recettes:0,   charge:800,  transit:2.0} },
    { id:13,  groupId:3, name:"Chatbot IA â€” assistance dÃ©clarative",      start:7,  duration:4, budget:155000000,  deps:[12,22],   ref:"Â§ 4.3", outcomes:{recettes:0,   charge:1500, transit:3.0} },
    { id:14,  groupId:3, name:"Notifications & suivi dossiers mobile",    start:10, duration:3, budget:70000000,   deps:[13],      ref:"Â§ 4.4", outcomes:{recettes:0,   charge:400,  transit:1.5} },
    { id:15,  groupId:3, name:"Ã‰valuation satisfaction & itÃ©ration",      start:13, duration:2, budget:25000000,   deps:[14],      ref:"Â§ 4.5", outcomes:{recettes:0,   charge:100,  transit:0.5} },

    // â”€â”€ G4 Performance opÃ©rationnelle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:16,  groupId:4, name:"Benchmark performances actuelles",         start:1,  duration:2, budget:25000000,   deps:[],        ref:"Â§ 5.1", outcomes:{recettes:0,   charge:100,  transit:0.5} },
    { id:17,  groupId:4, name:"Optimisation workflows dÃ©claration",       start:3,  duration:4, budget:95000000,   deps:[16,22],   ref:"Â§ 5.2", outcomes:{recettes:1.0, charge:2000, transit:2.5} },
    { id:18,  groupId:4, name:"Automatisation contrÃ´les documentaires",   start:6,  duration:5, budget:175000000,  deps:[17],      ref:"Â§ 5.3", outcomes:{recettes:0.5, charge:3500, transit:4.0} },
    { id:19,  groupId:4, name:"KPI & reporting automatisÃ©",               start:10, duration:3, budget:65000000,   deps:[18,23],   ref:"Â§ 5.4", outcomes:{recettes:0,   charge:1200, transit:1.0} },
    { id:20,  groupId:4, name:"DÃ©ploiement bureaux pilotes",              start:12, duration:4, budget:120000000,  deps:[19],      ref:"Â§ 5.5", outcomes:{recettes:0,   charge:600,  transit:1.5} },

    // â”€â”€ G5 Data Warehouse & Services communs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:21,  groupId:5, name:"Architecture Data Warehouse cible",        start:1,  duration:3, budget:90000000,   deps:[],        ref:"Â§ 6.1", outcomes:{recettes:0,   charge:300,  transit:0  } },
    { id:22,  groupId:5, name:"Pipelines ETL & intÃ©gration sources",      start:3,  duration:5, budget:210000000,  deps:[21],      ref:"Â§ 6.2", outcomes:{recettes:0.5, charge:500,  transit:0  } },
    { id:23,  groupId:5, name:"API centrale â€” couche accÃ¨s donnÃ©es",      start:7,  duration:4, budget:115000000,  deps:[22],      ref:"Â§ 6.3", outcomes:{recettes:0.5, charge:400,  transit:0.5} },
    { id:24,  groupId:5, name:"Master Data Management (MDM)",             start:6,  duration:4, budget:130000000,  deps:[22],      ref:"Â§ 6.4", outcomes:{recettes:1.0, charge:600,  transit:0  } },
    { id:25,  groupId:5, name:"SÃ©curitÃ© & conformitÃ© donnÃ©es",            start:5,  duration:6, budget:95000000,   deps:[21],      ref:"Â§ 6.5", outcomes:{recettes:0,   charge:200,  transit:0  } },

    // â”€â”€ G6 Gouvernance & Change Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:26,  groupId:6, name:"ComitÃ© de pilotage & charte projet",       start:1,  duration:1, budget:15000000,   deps:[],        ref:"Â§ 1.1", outcomes:{recettes:0,   charge:0,    transit:0  } },
    { id:27,  groupId:6, name:"Plan communication & conduite changement", start:2,  duration:3, budget:40000000,   deps:[26],      ref:"Â§ 1.2", outcomes:{recettes:0,   charge:0,    transit:0  } },
    { id:28,  groupId:6, name:"Formation leads & chefs de projet",        start:3,  duration:2, budget:35000000,   deps:[26],      ref:"Â§ 1.3", outcomes:{recettes:0,   charge:100,  transit:0  } },
    { id:29,  groupId:6, name:"Audits intermÃ©diaires (M6, M12)",          start:6,  duration:1, budget:20000000,   deps:[26],      ref:"Â§ 1.4", outcomes:{recettes:0,   charge:0,    transit:0  } },
    { id:30,  groupId:6, name:"ClÃ´ture & rapport final projet",           start:15, duration:2, budget:28000000,   deps:[5,10,15,20,25], ref:"Â§ 1.5", outcomes:{recettes:0, charge:0, transit:0} }
  ]
};

let nextTaskId  = 31;
let nextGroupId = 7;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENARIO HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getActiveScenario() {
  return project.scenarios.find(s => s.id === project.activeScenario) || project.scenarios[0];
}

function scenarioStats(sc) {
  const ids = new Set(sc.taskIds);
  const scTasks = project.tasks.filter(t => ids.has(t.id));
  const budget  = scTasks.reduce((s,t) => s + t.budget, 0);
  const sched   = computeSchedule(scTasks);
  let minS = Infinity, maxE = 0;
  scTasks.forEach(t => {
    const s = sched[t.id] || t.start;
    if (s < minS) minS = s;
    const e = s + t.duration;
    if (e > maxE) maxE = e;
  });
  const dur = scTasks.length ? (maxE - minS) : 0;
  return { budget, dur, count: scTasks.length };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VISIBILITY  (scenario filter + group toggle + dep pull-in)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getVisibleTasks() {
  const sc     = getActiveScenario();
  const scIds  = new Set(sc.taskIds);
  const visGids = new Set(project.groups.filter(g => g.visible).map(g => g.id));

  // Start: tasks in scenario AND in a visible group
  const direct = new Set(
    project.tasks.filter(t => scIds.has(t.id) && visGids.has(t.groupId)).map(t => t.id)
  );

  // Transitively include deps that are also in the scenario (even if their group is off)
  const required = new Set(direct);
  let changed = true;
  while (changed) {
    changed = false;
    project.tasks.forEach(t => {
      if (required.has(t.id)) {
        t.deps.forEach(d => {
          if (!required.has(d) && scIds.has(d)) { required.add(d); changed = true; }
        });
      }
    });
  }
  return project.tasks.filter(t => required.has(t.id));
}

function isBorrowed(taskId) {
  const visGids = new Set(project.groups.filter(g => g.visible).map(g => g.id));
  const t = project.tasks.find(t => t.id === taskId);
  return t && !visGids.has(t.groupId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEPENDENCY-AWARE SCHEDULING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function computeSchedule(visibleTasks) {
  const vtById = {};
  visibleTasks.forEach(t => { vtById[t.id] = t; });
  const scheduled = {}, visited = {};

  function solve(id) {
    if (scheduled[id] !== undefined) return scheduled[id];
    if (visited[id]) { scheduled[id] = 1; return 1; }
    visited[id] = true;
    const task = vtById[id];
    if (!task) { scheduled[id] = 1; return 1; }
    const activeDeps = (task.deps || []).filter(d => vtById[d] !== undefined);
    if (!activeDeps.length) { scheduled[id] = task.start; return task.start; }
    let depEnd = 0;
    activeDeps.forEach(depId => {
      const depStart = solve(depId);
      const end = depStart + (vtById[depId] ? vtById[depId].duration : 0);
      if (end > depEnd) depEnd = end;
    });
    scheduled[id] = depEnd;
    return depEnd;
  }
  visibleTasks.forEach(t => solve(t.id));
  return scheduled;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMELINE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getTotalMonths(schedule, vt) {
  if (!vt || !vt.length) return 18;
  let mx = 0;
  vt.forEach(t => { const e = (schedule[t.id]||t.start) + t.duration; if (e > mx) mx = e; });
  return Math.max(mx + 1, 12);
}

function monthLabel(m) {
  const base = new Date(project.startDate);
  const d = new Date(base.getFullYear(), base.getMonth() + m - 1, 1);
  return d.toLocaleString('fr-FR',{month:'short'}).replace('.','').toUpperCase();
}

function getQuarters(totalMonths) {
  const qs = []; let cur = null, cnt = 0;
  for (let m = 1; m <= totalMonths; m++) {
    const base = new Date(project.startDate);
    const d = new Date(base.getFullYear(), base.getMonth() + m - 1, 1);
    const q = `T${Math.ceil((d.getMonth()+1)/3)} ${d.getFullYear()}`;
    if (q !== cur) { if (cur) qs.push({label:cur,count:cnt}); cur=q; cnt=1; } else cnt++;
  }
  if (cur) qs.push({label:cur,count:cnt});
  return qs;
}

function formatBudget(n) {
  if (n >= 1e9) return (n/1e9).toLocaleString('fr-FR',{maximumFractionDigits:2}) + ' Md FCFA';
  if (n >= 1e6) return (n/1e6).toLocaleString('fr-FR',{maximumFractionDigits:0}) + ' M FCFA';
  return n.toLocaleString('fr-FR') + ' FCFA';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ENTRY POINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function render() {
  const vt       = getVisibleTasks();
  const schedule = computeSchedule(vt);
  renderScenarioTabs();
  renderOutcomes(vt);
  renderGroupControls();
  renderSummary(schedule, vt);
  renderGantt(schedule, vt);
}

// â”€â”€ Scenario tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderScenarioTabs() {
  const bar = document.getElementById('scenario-bar');
  bar.innerHTML = '<span class="scenario-bar-label">ScÃ©narios</span>';

  project.scenarios.forEach(sc => {
    const stats    = scenarioStats(sc);
    const isActive = sc.id === project.activeScenario;
    const badge    = SC_BADGE[sc.id] || { label: sc.id, bg:'#222', c:'#888' };

    const tab = document.createElement('div');
    tab.className = 'scenario-tab' + (isActive ? ' active' : '');
    tab.innerHTML = `
      <div class="sc-letter">${sc.label}</div>
      <div class="sc-name">${sc.name}</div>
      <div class="sc-subtitle">${sc.subtitle}</div>
      <div class="sc-meta">${stats.dur} mois Â· ${formatBudget(stats.budget)} Â· ${stats.count} tÃ¢ches</div>
      <span class="sc-badge" style="background:${badge.bg};color:${badge.c}">${badge.label}</span>`;
    tab.onclick = () => { project.activeScenario = sc.id; render(); };
    bar.appendChild(tab);
  });
}

// â”€â”€ Outcomes banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOutcomes(vt) {
  const bar = document.getElementById('outcomes-bar');
  if (!bar) return;

  // Sum outcomes across visible tasks
  const totals = {};
  (project.outcomes || []).forEach(oc => { totals[oc.id] = 0; });
  vt.forEach(t => {
    if (!t.outcomes) return;
    (project.outcomes || []).forEach(oc => {
      totals[oc.id] = (totals[oc.id] || 0) + (t.outcomes[oc.id] || 0);
    });
  });

  bar.innerHTML = '<span class="outcomes-label">RÃ©sultats attendus</span>';

  (project.outcomes || []).forEach(oc => {
    const val = totals[oc.id] || 0;
    const formatted = oc.unit === '%'
      ? (val % 1 === 0 ? val.toFixed(0) : val.toFixed(1)) + ' %'
      : val.toLocaleString('fr-FR') + ' ' + oc.unit;

    const card = document.createElement('div');
    card.className = 'outcome-card';
    card.style.borderColor = oc.color + '55';
    card.innerHTML = `
      <style>.outcome-card[data-oc="${oc.id}"]::before { background: ${oc.color}; }</style>
      <div class="oc-label">${oc.icon} ${oc.label}</div>
      <div class="oc-value" style="color:${oc.color}">${
        oc.unit === '%'
          ? (val % 1 === 0 ? val.toFixed(0) : val.toFixed(1))
          : val.toLocaleString('fr-FR')
      }<span class="oc-unit">${oc.unit}</span></div>
      <div class="oc-note">cumul des tÃ¢ches actives</div>`;
    card.dataset.oc = oc.id;
    bar.appendChild(card);
  });
}

// â”€â”€ Group toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGroupControls() {
  const ctrl = document.getElementById('group-controls');
  ctrl.innerHTML = '<span class="ctrl-label">Filtrer par groupe :</span>';

  const sc    = getActiveScenario();
  const scIds = new Set(sc.taskIds);
  const relevantGroups = project.groups.filter(g =>
    project.tasks.some(t => t.groupId === g.id && scIds.has(t.id))
  );

  relevantGroups.forEach(g => {
    const btn = document.createElement('div');
    btn.className = 'group-toggle' + (g.visible ? '' : ' off');
    btn.style.borderColor = g.color;
    btn.style.background  = g.visible ? g.color + '22' : 'transparent';
    btn.style.color       = g.visible ? g.color : 'var(--text-muted)';
    btn.innerHTML = `<span class="dot" style="background:${g.color}"></span>${g.name}`;
    btn.onclick = () => { g.visible = !g.visible; render(); };
    ctrl.appendChild(btn);
  });

  const sel = document.getElementById('inp-group');
  sel.innerHTML = '';
  project.groups.forEach(g => {
    const o = document.createElement('option');
    o.value = g.id; o.textContent = g.name;
    sel.appendChild(o);
  });
}

// â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary(schedule, vt) {
  const sc  = getActiveScenario();
  const bud = vt.reduce((s,t) => s + t.budget, 0);
  let minS = Infinity, maxE = 0;
  vt.forEach(t => {
    const s = schedule[t.id] || t.start;
    if (s < minS) minS = s;
    const e = s + t.duration;
    if (e > maxE) maxE = e;
  });
  const dur  = vt.length ? (maxE - minS) : 0;
  const visG = project.groups.filter(g => g.visible && vt.some(t => t.groupId === g.id));
  document.getElementById('sum-scenario').textContent = sc.name;
  document.getElementById('sum-dur').textContent      = dur  ? `${dur} mois` : 'â€”';
  document.getElementById('sum-bud').textContent      = bud  ? formatBudget(bud) : 'â€”';
  document.getElementById('sum-tasks').textContent    = vt.length;
  document.getElementById('sum-groups').textContent   = visG.length;
}

// â”€â”€ Gantt chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGantt(schedule, vt) {
  const body = document.getElementById('gantt-body');
  const svg  = document.getElementById('dep-svg');
  Array.from(body.children).forEach(c => { if (c !== svg) body.removeChild(c); });
  svg.innerHTML = '';

  const totalM = getTotalMonths(schedule, vt);
  renderHeader(totalM);

  if (!vt.length) {
    const em = document.createElement('div');
    em.className = 'empty';
    em.textContent = 'Aucune tÃ¢che visible pour ce scÃ©nario.';
    body.insertBefore(em, svg);
    return;
  }

  const taskRowMap = {};
  let yOff = 0;

  const visGroups = project.groups.filter(g => vt.some(t => t.groupId === g.id));

  visGroups.forEach(group => {
    const gTasks = vt.filter(t => t.groupId === group.id);
    if (!gTasks.length) return;

    const gBud       = gTasks.reduce((s,t) => s + t.budget, 0);
    const groupIsOff = !group.visible;

    // â”€â”€ Group header row
    const ghRow = document.createElement('div');
    ghRow.className = 'group-hdr-row';
    ghRow.style.opacity = groupIsOff ? '0.5' : '1';

    const ghLbl = document.createElement('div');
    ghLbl.className = 'group-hdr-lbl';
    ghLbl.innerHTML = `
      <span class="gcolor" style="background:${group.color}"></span>
      <span style="color:${group.color};flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${group.name}">${group.name}</span>
      ${groupIsOff ? '<span style="font-size:8px;color:var(--accent);background:var(--surface3);border:1px solid var(--accent);border-radius:3px;padding:1px 5px;margin-right:4px;flex-shrink:0;">REQUIS</span>' : ''}
      <span class="g-meta">${gTasks.length} tÃ¢che${gTasks.length>1?'s':''} Â· ${formatBudget(gBud)}</span>`;

    const ghTl   = document.createElement('div'); ghTl.className = 'group-hdr-tl';
    const tint   = document.createElement('div'); tint.className = 'group-tint'; tint.style.background = group.color;
    ghTl.appendChild(tint);
    ghRow.appendChild(ghLbl); ghRow.appendChild(ghTl);
    body.insertBefore(ghRow, svg);
    yOff += 38;

    // â”€â”€ Task rows
    gTasks.forEach(task => {
      const borrowed  = isBorrowed(task.id);
      const effStart  = schedule[task.id] || task.start;
      const sf = (effStart - 1) / totalM;
      const ef = (effStart - 1 + task.duration) / totalM;

      const row = document.createElement('div');
      row.className = 'task-row';

      const lbl = document.createElement('div');
      lbl.className = 'task-lbl';
      lbl.innerHTML = `
        <span class="task-id-badge">#${task.id}</span>
        <span class="task-nm" title="${task.name}">${task.name}</span>
        ${task.ref ? `<span class="task-ref">${task.ref}</span>` : ''}
        ${borrowed  ? '<span class="borrowed-badge">requis</span>' : ''}
        <span class="task-dur-lbl">M${effStart}+${task.duration}</span>
        <button class="task-del" onclick="deleteTask(${task.id})" title="Supprimer">âœ•</button>`;

      const tl   = document.createElement('div'); tl.className = 'task-tl';
      const grid = document.createElement('div'); grid.className = 'grid-ov';
      for (let i = 0; i < totalM; i++) {
        const gc = document.createElement('div'); gc.className = 'grid-col'; grid.appendChild(gc);
      }
      tl.appendChild(grid);

      const bar = document.createElement('div');
      bar.className = 'task-bar';
      bar.style.left       = (sf * 100) + '%';
      bar.style.width      = Math.max((ef - sf) * 100, 0.3) + '%';
      bar.style.background = group.color;
      bar.style.opacity    = borrowed ? '0.5' : '1';
      // Store logical time positions for print recalculation
      bar.dataset.startMonth = effStart;        // 1-based month this bar starts
      bar.dataset.durMonths  = task.duration;   // duration in months
      bar.dataset.totalM     = totalM;          // total months in timeline

      // Build dep list for print
      const depNames = (task.deps || []).map(d => {
        const dt = project.tasks.find(t => t.id === d);
        return dt ? ('#' + d + ' ' + dt.name) : ('#' + d);
      }).join(', ');

      // Build outcomes lines for print card
      const ocLines = (project.outcomes || []).map(oc => {
        const val = task.outcomes ? (task.outcomes[oc.id] || 0) : 0;
        if (!val) return '';
        const fVal = oc.unit === '%'
          ? (val % 1 === 0 ? val.toFixed(0) : val.toFixed(1)) + 'â€¯%'
          : val.toLocaleString('fr-FR') + 'â€¯' + oc.unit;
        return '<span class="bpi-oc-row"><span>' + oc.icon + ' ' + oc.label + '</span><span>' + fVal + '</span></span>';
      }).filter(Boolean).join('');

      bar.innerHTML =
        '<span class="bar-txt">' + task.name + '</span>' +
        '<span class="bar-print-info">' +
          '<span class="bpi-name">' + task.name + '</span>' +
          (task.ref ? '<span class="bpi-ref">' + task.ref + '</span>' : '') +
          '<span class="bpi-dates">M+' + effStart + ' â†’ M+' + (effStart + task.duration - 1) + ' (' + task.duration + ' mois)</span>' +
          '<span class="bpi-budget">' + formatBudget(task.budget) + '</span>' +
          (ocLines ? '<span class="bpi-outcomes">' + ocLines + '</span>' : '') +
          (depNames ? '<span class="bpi-deps">â†³ ' + depNames + '</span>' : '') +
        '</span>';

      bar.addEventListener('mouseenter', e => showTooltip(e, task, group, effStart));
      bar.addEventListener('mousemove',  e => moveTooltip(e));
      bar.addEventListener('mouseleave', hideTooltip);
      tl.appendChild(bar);

      row.appendChild(lbl); row.appendChild(tl);
      body.insertBefore(row, svg);
      taskRowMap[task.id] = { y: yOff + 18, sf, ef, color: group.color };
      yOff += 36;
    });
  });

  // â”€â”€ SVG dependency arrows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rect = document.getElementById('gantt-inner').getBoundingClientRect();
  const LW   = 360;
  const TW   = Math.max(rect.width - LW - 2, 400);
  svg.setAttribute('width',  rect.width); svg.style.width  = rect.width  + 'px';
  svg.setAttribute('height', yOff);       svg.style.height = yOff + 'px';

  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  svg.appendChild(defs);

  vt.forEach(task => {
    if (!task.deps.length) return;
    const to = taskRowMap[task.id]; if (!to) return;
    task.deps.forEach((depId, di) => {
      const from = taskRowMap[depId]; if (!from) return;
      const mid = `a${depId}_${task.id}_${di}`;
      const mk  = document.createElementNS('http://www.w3.org/2000/svg','marker');
      mk.setAttribute('id',mid); mk.setAttribute('markerWidth','7'); mk.setAttribute('markerHeight','7');
      mk.setAttribute('refX','6'); mk.setAttribute('refY','3'); mk.setAttribute('orient','auto');
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('points','0 0, 7 3, 0 6');
      poly.setAttribute('fill', from.color); poly.setAttribute('opacity','0.7');
      mk.appendChild(poly); defs.appendChild(mk);

      const x1 = LW + from.ef * TW, y1 = from.y;
      const x2 = LW + to.sf   * TW, y2 = to.y;
      const bend = Math.min(50, Math.abs(x2-x1)*0.45 + 10);

      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', `M ${x1} ${y1} C ${x1+bend} ${y1}, ${x2-bend} ${y2}, ${x2} ${y2}`);
      path.setAttribute('stroke', from.color);
      path.setAttribute('stroke-width','1.5');
      path.setAttribute('stroke-dasharray','5,3');
      path.setAttribute('fill','none');
      path.setAttribute('opacity','0.5');
      path.setAttribute('marker-end', `url(#${mid})`);
      svg.appendChild(path);
    });
  });
}

function renderHeader(totalM) {
  const qEl = document.getElementById('g-quarters');
  const mEl = document.getElementById('g-months');
  qEl.innerHTML = ''; mEl.innerHTML = '';
  getQuarters(totalM).forEach(q => {
    const el = document.createElement('div');
    el.className = 'g-quarter'; el.textContent = q.label; el.style.flex = q.count;
    qEl.appendChild(el);
  });
  for (let m = 1; m <= totalM; m++) {
    const el = document.createElement('div');
    el.className = 'g-month'; el.textContent = monthLabel(m);
    mEl.appendChild(el);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOLTIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showTooltip(ev, task, group, effStart) {
  const tt = document.getElementById('tooltip');
  const depLines = task.deps.length
    ? task.deps.map(d => { const dt = project.tasks.find(t=>t.id===d); return '#'+d+(dt?' â€” '+dt.name:''); }).join('<br>')
    : 'â€”';

  // Outcome contribution rows
  const ocRows = (project.outcomes || []).map(oc => {
    const val = task.outcomes ? (task.outcomes[oc.id] || 0) : 0;
    if (!val) return '';
    const fVal = oc.unit === '%'
      ? (val % 1 === 0 ? val.toFixed(0) : val.toFixed(1)) + 'â€¯%'
      : val.toLocaleString('fr-FR') + 'â€¯' + oc.unit;
    return '<div class="tt-oc-row"><span>' + oc.icon + ' ' + oc.label + '</span>'
         + '<span style="color:' + oc.color + '">' + fVal + '</span></div>';
  }).join('');

  tt.innerHTML =
    '<div class="tt-name" style="color:' + group.color + '">' + task.name + '</div>'
    + '<div class="tt-row"><span>Groupe</span><span>' + group.name + '</span></div>'
    + '<div class="tt-row"><span>DÃ©but</span><span>M+' + effStart + '</span></div>'
    + '<div class="tt-row"><span>DurÃ©e</span><span>' + task.duration + ' mois</span></div>'
    + '<div class="tt-row"><span>Fin</span><span>M+' + (effStart + task.duration - 1) + '</span></div>'
    + '<div class="tt-row"><span>Budget</span><span>' + formatBudget(task.budget) + '</span></div>'
    + (task.ref ? '<div class="tt-section"><b>RÃ©f. document</b><span class="tt-ref-tag">' + task.ref + '</span></div>' : '')
    + (ocRows ? '<div class="tt-outcomes"><b>Contributions</b>' + ocRows + '</div>' : '')
    + '<div class="tt-section"><b>DÃ©pendances</b>' + depLines + '</div>';

  tt.classList.add('show');
  moveTooltip(ev);
}
function moveTooltip(ev) {
  const tt = document.getElementById('tooltip');
  tt.style.left = Math.min(ev.clientX+18, window.innerWidth-260)+'px';
  tt.style.top  = Math.min(ev.clientY+18, window.innerHeight-260)+'px';
}
function hideTooltip() { document.getElementById('tooltip').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function deleteTask(id) {
  project.tasks = project.tasks.filter(t => t.id !== id);
  project.tasks.forEach(t => { t.deps = t.deps.filter(d => d !== id); });
  project.scenarios.forEach(sc => { sc.taskIds = sc.taskIds.filter(i => i !== id); });
  render();
}

function addTask() {
  const name   = document.getElementById('inp-name').value.trim();
  const gid    = parseInt(document.getElementById('inp-group').value);
  const start  = parseInt(document.getElementById('inp-start').value);
  const dur    = parseInt(document.getElementById('inp-dur').value);
  const budget = parseFloat(document.getElementById('inp-budget').value) || 0;
  const dRaw   = document.getElementById('inp-deps').value.trim();
  const deps   = dRaw ? dRaw.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n)) : [];
  const ref    = document.getElementById('inp-ref').value.trim();
  if (!name || !start || !dur) { alert('Nom, mois de dÃ©but et durÃ©e sont requis.'); return; }
  const newId = nextTaskId++;
  project.tasks.push({ id:newId, groupId:gid, name, start, duration:dur, budget, deps, ref: ref||'' });
  getActiveScenario().taskIds.push(newId);
  ['inp-name','inp-budget','inp-deps','inp-ref'].forEach(id => { document.getElementById(id).value=''; });
  render();
}

function addGroup() {
  const name = prompt('Nom du nouveau groupe :');
  if (!name) return;
  project.groups.push({ id:nextGroupId++, name, color: PALETTE[nextGroupId % PALETTE.length], visible:true });
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JSON PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleJson() {
  const panel = document.getElementById('json-panel');
  const btn   = document.getElementById('json-btn');
  const open  = !panel.classList.contains('open');
  panel.classList.toggle('open', open);
  btn.classList.toggle('active', open);
  if (open) {
    document.getElementById('json-editor').value = JSON.stringify(project, null, 2);
    document.getElementById('json-err').classList.remove('show');
  }
}

function applyJson() {
  const errEl = document.getElementById('json-err');
  try {
    const p = JSON.parse(document.getElementById('json-editor').value);
    if (!Array.isArray(p.groups)||!Array.isArray(p.tasks)||!Array.isArray(p.scenarios))
      throw new Error('"groups", "tasks" et "scenarios" doivent Ãªtre des tableaux.');
    p.groups.forEach(g => { if (!g.id||!g.name) throw new Error('Groupe invalide'); if(g.visible===undefined) g.visible=true; });
    p.tasks.forEach(t => { if (!t.id||!t.name||!t.start||!t.duration) throw new Error('TÃ¢che invalide: '+t.id); if(!t.deps) t.deps=[]; if(!t.budget) t.budget=0; if(!t.ref) t.ref=''; if(!t.outcomes) t.outcomes={}; });
    if (!p.outcomes) p.outcomes = [];
    p.scenarios.forEach(sc => { if (!sc.id||!sc.name) throw new Error('ScÃ©nario invalide'); if(!sc.taskIds) sc.taskIds=[]; });
    project = p;
    if (!project.activeScenario) project.activeScenario = project.scenarios[0].id;
    nextTaskId  = Math.max(...project.tasks.map(t=>t.id),  nextTaskId-1)  + 1;
    nextGroupId = Math.max(...project.groups.map(g=>g.id), nextGroupId-1) + 1;
    errEl.classList.remove('show');
    render();
  } catch(e) {
    errEl.textContent = 'âš  ' + e.message;
    errEl.classList.add('show');
  }
}

document.getElementById('json-editor').addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key==='s') { e.preventDefault(); applyJson(); }
  if (e.key==='Tab') {
    e.preventDefault();
    const ta=e.target, s=ta.selectionStart, end=ta.selectionEnd;
    ta.value=ta.value.substring(0,s)+'  '+ta.value.substring(end);
    ta.selectionStart=ta.selectionEnd=s+2;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  const btn = document.getElementById('theme-btn');
  btn.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  btn.title = isLight ? 'Passer en mode nuit' : 'Passer en mode jour';
  localStorage.setItem('gantt-theme', isLight ? 'light' : 'dark');
}

(function() {
  if (localStorage.getItem('gantt-theme') === 'light') {
    document.body.classList.add('light');
    window.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('theme-btn');
      if (btn) { btn.textContent = 'â˜€ï¸'; btn.title = 'Passer en mode nuit'; }
    });
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRINT PREPARATION
//  Before printing: convert each .task-bar from position:absolute
//  (left: X%) to position:relative with margin-left: X% so the bar
//  is in normal flow and the row can grow to fit its content.
//  After printing: restore to absolute positioning.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRINT PREPARATION
//
//  Strategy: keep bars at position:absolute so left/width % remain
//  accurate for time alignment. Instead, measure how tall each bar's
//  content needs to be (by briefly rendering it at its actual pixel
//  width in a hidden off-screen container), then set that height
//  explicitly on the bar, the .task-tl, and the .task-row so every
//  row is tall enough to show all content.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Minimum readable bar width in print (px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// This is the target width for the narrowest task's bar.
// JS will enforce this by setting min-width on each month column,
// making the timeline as wide as needed.
const PRINT_MIN_BAR_PX = 110; // ~1.5 inches at 72dpi

function calcPrintColMinWidth(vt, schedule, totalM) {
  // Find the smallest task duration among visible tasks
  let minDur = Infinity;
  vt.forEach(t => { if (t.duration < minDur) minDur = t.duration; });
  if (!isFinite(minDur) || minDur < 1) minDur = 1;

  // How many month-columns does the smallest bar span?
  // That bar occupies minDur columns out of totalM.
  // We want minDur * colWidth >= PRINT_MIN_BAR_PX
  // => colWidth >= PRINT_MIN_BAR_PX / minDur
  const minColW = Math.ceil(PRINT_MIN_BAR_PX / minDur);

  // Also ensure it's at least a comfortable 36px regardless
  return Math.max(minColW, 36);
}

function prepareForPrint() {
  document.body.classList.add('printing');

  // â”€â”€ Step 1: slim label columns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SLIM = '52px';
  document.querySelectorAll('.task-lbl').forEach(el => {
    el.dataset.origW = el.style.width; el.dataset.origMW = el.style.minWidth;
    el.style.width = SLIM; el.style.minWidth = SLIM;
  });
  document.querySelectorAll('.g-label-hdr, .group-hdr-lbl').forEach(el => {
    el.dataset.origW = el.style.width; el.dataset.origMW = el.style.minWidth;
    el.style.width = SLIM; el.style.minWidth = SLIM;
  });

  // â”€â”€ Step 2: enforce min column width so narrowest bar is readable â”€
  // Read current visible tasks + schedule from the rendered gantt
  const vt       = getVisibleTasks();
  const schedule = computeSchedule(vt);
  const totalM   = getTotalMonths(schedule, vt);
  const colMinW  = calcPrintColMinWidth(vt, schedule, totalM);

  // Set min-width on every month header cell â€” flex container will expand
  document.querySelectorAll('.g-month').forEach(el => {
    el.dataset.origMinW = el.style.minWidth;
    el.style.minWidth = colMinW + 'px';
  });
  // Mirror onto grid columns so grid lines stay aligned with headers
  document.querySelectorAll('.grid-col').forEach(el => {
    el.dataset.origMinW = el.style.minWidth;
    el.style.minWidth = colMinW + 'px';
  });
  // Quarter cells: their flex span is set via flex property, not width,
  // so they'll stretch naturally. But set min-width too for safety.
  document.querySelectorAll('.g-quarter').forEach(el => {
    el.dataset.origMinW = el.style.minWidth;
    // quarter spans N months, so min-width = N * colMinW
    const span = parseInt(el.style.flex) || 1;
    el.style.minWidth = (span * colMinW) + 'px';
  });

  // â”€â”€ Step 3: convert bar positions from % to px â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // The % values were computed against the original screen layout width.
  // Now that colMinW is enforced, bars must be repositioned using
  // exact pixel values: left = (startMonth-1) * colMinW,
  //                     width = duration * colMinW  (minus 1px gap)
  document.querySelectorAll('.task-bar').forEach(bar => {
    bar.dataset.origLeft  = bar.style.left;
    bar.dataset.origWidth = bar.style.width;
    const startM = parseInt(bar.dataset.startMonth) || 1;
    const durM   = parseInt(bar.dataset.durMonths)  || 1;
    bar.style.left  = ((startM - 1) * colMinW) + 'px';
    bar.style.width = Math.max(durM * colMinW - 1, 4) + 'px';
  });

  // â”€â”€ Step 4: measure bar content height and set row heights â”€â”€â”€â”€â”€â”€
  // Bars now have accurate pixel widths â€” use a probe to measure
  // how tall the content needs to be, then set heights on rows.
  const probe = document.createElement('div');
  probe.style.cssText = [
    'position:fixed', 'visibility:hidden', 'pointer-events:none',
    'top:-9999px', 'left:0',
    'display:flex', 'flex-direction:column', 'gap:2px',
    'padding:5px 7px', 'border-radius:4px',
    'font-family:Syne,sans-serif', 'box-sizing:border-box',
    'overflow:hidden'
  ].join(';');
  document.body.appendChild(probe);

  document.querySelectorAll('.task-row').forEach(row => {
    const tl  = row.querySelector('.task-tl');
    const bar = row.querySelector('.task-bar');
    if (!tl || !bar) return;

    bar.dataset.origH   = bar.style.height;
    bar.dataset.origTop = bar.style.top;
    tl.dataset.origH    = tl.style.height;
    row.dataset.origH   = row.style.height;

    // Bar pixel width is now absolute â€” read it directly
    const barW = parseFloat(bar.style.width) || 80;

    const info = bar.querySelector('.bar-print-info');
    if (!info) return;

    probe.style.width = Math.max(barW, 40) + 'px';
    probe.innerHTML   = info.outerHTML;

    // Apply print font sizes so measurement matches rendered output
    const pName = probe.querySelector('.bpi-name');
    const pRef  = probe.querySelector('.bpi-ref');
    const pDate = probe.querySelector('.bpi-dates');
    const pBud  = probe.querySelector('.bpi-budget');
    const pDeps = probe.querySelector('.bpi-deps');
    if (pName) pName.style.cssText = 'font-size:8px;font-weight:700;line-height:1.25;white-space:normal;word-break:break-word;color:#fff;';
    if (pRef)  pRef.style.cssText  = 'font-size:6.5px;display:inline-block;padding:1px 3px;color:#fff;';
    if (pDate) pDate.style.cssText = 'font-size:6.5px;color:#fff;';
    if (pBud)  pBud.style.cssText  = 'font-size:7px;font-weight:700;color:#fff;';
    if (pDeps) pDeps.style.cssText = 'font-size:6px;white-space:normal;word-break:break-word;line-height:1.35;color:#fff;';

    const contentH = probe.scrollHeight;
    const rowH     = contentH + 10; // 4px top + 6px bottom breathing room

    bar.style.height = contentH + 'px';
    bar.style.top    = '4px';
    tl.style.height  = rowH + 'px';
    row.style.height = rowH + 'px';
  });

  probe.remove();
}

function restoreAfterPrint() {
  document.body.classList.remove('printing');

  // Restore column min-widths
  document.querySelectorAll('.g-month, .grid-col, .g-quarter').forEach(el => {
    el.style.minWidth = el.dataset.origMinW || '';
  });

  // Restore bar positions and row heights
  document.querySelectorAll('.task-row').forEach(row => {
    const tl  = row.querySelector('.task-tl');
    const bar = row.querySelector('.task-bar');
    if (!tl || !bar) return;
    bar.style.left   = bar.dataset.origLeft  || '';
    bar.style.width  = bar.dataset.origWidth || '';
    bar.style.height = bar.dataset.origH     || '';
    bar.style.top    = bar.dataset.origTop   || '';
    tl.style.height  = tl.dataset.origH      || '';
    row.style.height = row.dataset.origH      || '';
  });

  // Restore label widths
  document.querySelectorAll('.task-lbl').forEach(el => {
    el.style.width = el.dataset.origW || ''; el.style.minWidth = el.dataset.origMW || '';
  });
  document.querySelectorAll('.g-label-hdr, .group-hdr-lbl').forEach(el => {
    el.style.width = el.dataset.origW || ''; el.style.minWidth = el.dataset.origMW || '';
  });
}

window.addEventListener('beforeprint', prepareForPrint);
window.addEventListener('afterprint',  restoreAfterPrint);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let resizeTimer;
window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(render, 120); });

render();
</script>
</body>
</html>
