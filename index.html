<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAMCIS AI ‚Äî Gantt Chart</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg: #0d1018;
    --surface: #141824;
    --surface2: #1a2030;
    --surface3: #1f2640;
    --border: #252d42;
    --border2: #2e3850;
    --text: #dde2f0;
    --text-muted: #5a6285;
    --text-dim: #8892b0;
    --accent: #4f6ef7;
    --danger: #f87171;
    --row-h: 36px;
    --label-w: 360px;
    --header-h: 60px;
  }

  body.light {
    --bg: #f4f6fb; --surface: #ffffff; --surface2: #eef1f8; --surface3: #e2e7f4;
    --border: #d5daea; --border2: #b8c2d8; --text: #1a2040; --text-muted: #7a85aa;
    --text-dim: #4a5278; --accent: #3a5ce6; --danger: #dc2626;
  }
  body.light #json-editor { background: #f8f9fc; color: #1a6b3a; }
  body.light ::-webkit-scrollbar-track { background: #eef1f8; }
  body.light ::-webkit-scrollbar-thumb { background: #c8cedf; }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif;
    min-height: 100vh; display: flex; flex-direction: column;
    overflow: hidden; height: 100vh;
  }

  /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
  .topbar {
    padding: 10px 20px; background: var(--surface); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 14px; flex-wrap: wrap; flex-shrink: 0;
  }
  .topbar-title h1 { font-size: 17px; font-weight: 800; letter-spacing: -0.3px; color: var(--text); line-height: 1; }
  .topbar-title h1 span { color: var(--accent); }
  .topbar-title .subtitle { font-size: 9px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-top: 3px; }
  .topbar-pills { display: flex; gap: 6px; flex-wrap: wrap; flex: 1; }
  .pill { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text-muted); white-space: nowrap; }
  .pill b { color: var(--text); font-weight: 500; }
  .pill.highlight  { border-color: var(--accent); }
  .pill.highlight b { color: var(--accent); }
  .pill.green   { border-color: #22c55e44; }
  .pill.green  b { color: #4ade80; }
  .pill.orange  { border-color: #f9731644; }
  .pill.orange b { color: #fb923c; }
  .pill.teal    { border-color: #14b8a644; }
  .pill.teal   b { color: #2dd4bf; }
  .topbar-actions { display: flex; gap: 7px; }
  .btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 13px; border-radius: 7px; font-size: 12px; font-weight: 700; font-family: 'Syne', sans-serif; cursor: pointer; border: none; transition: filter .15s, background .15s; }
  .btn:hover { filter: brightness(1.15); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-ghost { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); }
  .btn-ghost.active { background: var(--surface3); border-color: var(--accent); color: var(--accent); }

  /* ‚îÄ‚îÄ SCENARIO BAR ‚îÄ‚îÄ */
  .scenario-bar {
    display: flex; align-items: stretch; background: var(--surface);
    border-bottom: 2px solid var(--border2); flex-shrink: 0; overflow-x: auto;
  }
  .scenario-bar-label {
    font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted);
    padding: 0 16px; display: flex; align-items: center; border-right: 1px solid var(--border);
    white-space: nowrap; flex-shrink: 0;
  }
  .scenario-tab {
    position: relative; display: flex; flex-direction: column; justify-content: center;
    padding: 9px 40px 9px 16px; cursor: pointer; border-right: 1px solid var(--border);
    border-bottom: 3px solid transparent; transition: background .15s, border-color .15s;
    min-width: 220px; user-select: none; flex-shrink: 0;
  }
  .scenario-tab:hover { background: var(--surface2); }
  .scenario-tab.active { background: var(--surface2); border-bottom-color: var(--accent); }
  .sc-letter { font-size: 9px; font-weight: 800; font-family: 'DM Mono', monospace; letter-spacing: 1px; margin-bottom: 1px; }
  .scenario-tab.active .sc-letter { color: var(--accent); }
  .scenario-tab:not(.active) .sc-letter { color: var(--text-muted); }
  .sc-name { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .scenario-tab.active .sc-name { color: var(--text); }
  .scenario-tab:not(.active) .sc-name { color: var(--text-muted); }
  .sc-subtitle { font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
  .sc-meta { font-size: 9px; color: var(--text-muted); font-family: 'DM Mono', monospace; margin-top: 3px; white-space: nowrap; }
  .scenario-tab.active .sc-meta { color: var(--text-dim); }
  .sc-kpis { display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; }
  .sc-kpi { font-size: 8px; font-family: 'DM Mono', monospace; padding: 1px 5px; border-radius: 3px; white-space: nowrap; font-weight: 700; }
  .sc-badge { position: absolute; top: 8px; right: 8px; font-size: 8px; font-weight: 700; padding: 2px 5px; border-radius: 3px; letter-spacing: 0.5px; white-space: nowrap; }

  /* ‚îÄ‚îÄ GROUP CONTROLS ‚îÄ‚îÄ */
  .controls { padding: 7px 20px; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; background: var(--bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .ctrl-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-right: 4px; flex-shrink: 0; }
  .group-toggle { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 20px; border: 1.5px solid; cursor: pointer; font-size: 11px; font-weight: 600; transition: opacity .2s, background .2s; user-select: none; white-space: nowrap; }
  .group-toggle.off { opacity: 0.28; background: transparent !important; }
  .group-toggle .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

  /* ‚îÄ‚îÄ ADD BAR ‚îÄ‚îÄ */
  .add-bar { padding: 7px 20px; display: flex; gap: 7px; flex-wrap: wrap; align-items: center; background: var(--bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .add-bar input, .add-bar select { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 5px 9px; font-size: 11px; font-family: 'DM Mono', monospace; outline: none; transition: border-color .2s; }
  .add-bar input:focus, .add-bar select:focus { border-color: var(--accent); }
  .add-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); flex-shrink: 0; }

  /* ‚îÄ‚îÄ JSON PANEL ‚îÄ‚îÄ */
  .json-panel { background: var(--surface); border-bottom: 1px solid var(--border); display: none; flex-direction: column; flex-shrink: 0; max-height: 360px; }
  .json-panel.open { display: flex; }
  .json-panel-hdr { padding: 9px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .json-panel-hdr span { flex: 1; font-size: 11px; color: var(--text-muted); font-family: 'DM Mono', monospace; }
  .json-err { padding: 5px 20px; font-size: 11px; font-family: 'DM Mono', monospace; color: var(--danger); background: #2a1010; display: none; flex-shrink: 0; }
  .json-err.show { display: block; }
  #json-editor { flex: 1; background: #090c12; color: #7ec897; border: none; padding: 14px 20px; font-family: 'DM Mono', monospace; font-size: 11px; line-height: 1.75; resize: none; outline: none; overflow-y: auto; tab-size: 2; }

  /* ‚îÄ‚îÄ GANTT ‚îÄ‚îÄ */
  .gantt-scroll { flex: 1; overflow: auto; position: relative; }
  .gantt-inner  { min-width: 960px; display: flex; flex-direction: column; min-height: 100%; }
  .gantt-header { display: flex; position: sticky; top: 0; z-index: 30; }
  .g-label-hdr  { width: var(--label-w); min-width: var(--label-w); height: var(--header-h); background: var(--surface); border: 1px solid var(--border); border-right: 2px solid var(--border2); padding: 0 14px; display: flex; align-items: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); position: sticky; left: 0; z-index: 31; }
  .g-timeline-hdr { flex: 1; height: var(--header-h); background: var(--surface); border: 1px solid var(--border); border-left: none; overflow: hidden; display: flex; flex-direction: column; }
  .g-quarters { display: flex; height: 24px; border-bottom: 1px solid var(--border); }
  .g-quarter  { display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); border-right: 1px solid var(--border); }
  .g-quarter:last-child { border-right: none; }
  .g-months { display: flex; flex: 1; }
  .g-month  { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; letter-spacing: 0.8px; color: var(--text-muted); border-right: 1px solid var(--border); text-transform: uppercase; }
  .g-month:last-child { border-right: none; }

  .gantt-body { position: relative; flex: 1; }
  .group-hdr-row { display: flex; height: 38px; border-top: 2px solid var(--border2); }
  .group-hdr-lbl { width: var(--label-w); min-width: var(--label-w); background: var(--surface2); border-right: 2px solid var(--border2); padding: 0 14px; display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; position: sticky; left: 0; z-index: 11; }
  .gcolor { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
  .g-meta { margin-left: auto; font-weight: 400; font-size: 9px; color: var(--text-muted); font-family: 'DM Mono', monospace; white-space: nowrap; }
  .group-hdr-tl  { flex: 1; background: var(--surface2); position: relative; overflow: hidden; }
  .group-tint    { position: absolute; inset: 0; opacity: 0.05; }

  .task-row { display: flex; height: var(--row-h); border-top: 1px solid var(--border); }
  .task-row:hover .task-lbl { background: var(--surface2); }
  .task-lbl { width: var(--label-w); min-width: var(--label-w); padding: 0 10px 0 14px; display: flex; align-items: center; gap: 6px; border-right: 2px solid var(--border2); background: var(--bg); transition: background .12s; position: sticky; left: 0; z-index: 10; }
  .task-id-badge { font-size: 9px; font-family: 'DM Mono', monospace; color: var(--text-muted); min-width: 20px; flex-shrink: 0; }
  .task-nm  { flex: 1; font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .task-ref { font-size: 8px; color: var(--accent); font-family: 'DM Mono', monospace; background: var(--surface3); border: 1px solid var(--border2); border-radius: 3px; padding: 1px 4px; flex-shrink: 0; white-space: nowrap; }
  .task-dur-lbl { font-size: 9px; color: var(--text-muted); font-family: 'DM Mono', monospace; white-space: nowrap; flex-shrink: 0; }
  .task-del { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 11px; padding: 0 2px; opacity: 0; transition: opacity .12s, color .12s; flex-shrink: 0; }
  .task-row:hover .task-del { opacity: 1; }
  .task-del:hover { color: var(--danger); }

  .task-tl  { flex: 1; position: relative; overflow: hidden; }
  .grid-ov  { position: absolute; inset: 0; display: flex; pointer-events: none; }
  .grid-col { flex: 1; border-right: 1px solid var(--border); opacity: 0.35; }
  .grid-col:last-child { border-right: none; }

  .task-bar { position: absolute; height: 20px; top: 50%; transform: translateY(-50%); border-radius: 4px; cursor: pointer; transition: filter .12s; display: flex; align-items: center; padding: 0 6px; overflow: hidden; min-width: 4px; }
  .task-bar:hover { filter: brightness(1.3); }
  .bar-txt  { font-size: 10px; font-weight: 600; color: rgba(0,0,0,0.72); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.1px; }
  .borrowed-badge { font-size: 8px; color: var(--accent); background: var(--surface3); border: 1px solid var(--accent); border-radius: 3px; padding: 1px 4px; flex-shrink: 0; }
  #dep-svg { position: absolute; inset: 0; pointer-events: none; z-index: 5; overflow: visible; }

  /* ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ */
  .tooltip { position: fixed; background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px; padding: 12px 16px; pointer-events: none; z-index: 9999; opacity: 0; transition: opacity .1s; min-width: 260px; max-width: 320px; box-shadow: 0 12px 40px rgba(0,0,0,0.65); }
  .tooltip.show { opacity: 1; }
  .tt-name  { font-size: 13px; font-weight: 700; margin-bottom: 9px; line-height: 1.3; }
  .tt-row   { display: flex; justify-content: space-between; gap: 18px; margin-top: 5px; color: var(--text-muted); font-size: 11px; }
  .tt-row span:last-child { color: var(--text); font-family: 'DM Mono', monospace; text-align: right; }
  .tt-section { margin-top: 9px; font-size: 10px; line-height: 1.7; color: var(--text-muted); }
  .tt-section b { color: var(--text-dim); display: block; margin-bottom: 2px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; }
  .tt-ref-tag { display: inline-block; color: var(--accent); font-family: 'DM Mono', monospace; background: var(--surface3); border: 1px solid var(--border2); border-radius: 3px; padding: 1px 6px; font-size: 10px; }
  .tt-metrics { margin-top: 9px; display: flex; flex-direction: column; gap: 4px; }
  .tt-metric  { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 4px 8px; border-radius: 5px; font-size: 10px; }
  .tt-metric .tm-label { color: var(--text-muted); }
  .tt-metric .tm-val   { font-family: 'DM Mono', monospace; font-weight: 700; }
  .tt-metric.rev   { background: #4ade8011; }
  .tt-metric.rev   .tm-val { color: #4ade80; }
  .tt-metric.work  { background: #fb923c11; }
  .tt-metric.work  .tm-val { color: #fb923c; }
  .tt-metric.trnst { background: #2dd4bf11; }
  .tt-metric.trnst .tm-val { color: #2dd4bf; }

  .empty { padding: 60px; text-align: center; color: var(--text-muted); font-size: 13px; }
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .bar-print-info { display: none; }

  /* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
  @media print {
    body, body.light {
      --bg:#fff; --surface:#fff; --surface2:#f2f4f8; --surface3:#e8ecf4;
      --border:#d0d5e8; --border2:#b0b8d0; --text:#111827; --text-muted:#6b7280;
      --text-dim:#374151; --accent:#2563eb;
      background:#fff !important; color:#111827 !important;
      height:auto !important; overflow:visible !important;
    }
    .topbar-actions, .scenario-bar, .controls, .add-bar, .json-panel, .tooltip, .task-del, .borrowed-badge { display:none !important; }
    body, .gantt-scroll, .gantt-inner, .gantt-body, .task-tl { overflow:visible !important; height:auto !important; max-height:none !important; flex-shrink:0 !important; }
    .gantt-scroll { flex:none; }
    .gantt-header, .g-label-hdr, .task-lbl, .group-hdr-lbl { position:static !important; }
    .topbar { padding:8px 16px; border-bottom:2px solid #111; margin-bottom:4px; background:#fff !important; }
    .topbar-title h1 { font-size:14px; color:#111 !important; }
    .topbar-title h1 span { color:#2563eb !important; }
    .topbar-title .subtitle { color:#666 !important; }
    .topbar-pills .pill { background:#f2f4f8 !important; border-color:#ccc !important; color:#444 !important; }
    .topbar-pills .pill b { color:#111 !important; }
    .topbar-pills .pill.highlight { border-color:#2563eb !important; }
    .topbar-pills .pill.highlight b { color:#2563eb !important; }
    .group-hdr-row { background:#f2f4f8 !important; break-inside:avoid; }
    .group-hdr-lbl { background:#f2f4f8 !important; color:#111 !important; }
    .task-row { height:auto !important; min-height:64px; break-inside:avoid; page-break-inside:avoid; }
    .task-lbl { background:#fff !important; min-height:64px; height:auto !important; padding-top:6px; padding-bottom:6px; align-items:flex-start !important; }
    .task-nm  { white-space:normal !important; font-size:11px !important; }
    .task-ref { font-size:8px !important; }
    .grid-col { border-color:#e0e4ef !important; opacity:1 !important; }
    .task-bar { height:calc(100% - 8px) !important; min-height:56px !important; top:4px !important; transform:none !important; border-radius:5px !important; overflow:visible !important; align-items:flex-start !important; padding:5px 7px !important; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
    .bar-txt { display:none !important; }
    .bar-print-info { display:flex !important; flex-direction:column; gap:2px; width:100%; overflow:hidden; }
    .bar-print-info .bpi-name   { font-family:'Syne',sans-serif; font-size:9px; font-weight:700; color:#fff; line-height:1.3; white-space:normal; word-break:break-word; }
    .bar-print-info .bpi-ref    { font-family:'DM Mono',monospace; font-size:7.5px; font-weight:600; color:rgba(255,255,255,0.85); background:rgba(0,0,0,0.18); border-radius:2px; padding:0px 4px; display:inline-block; width:fit-content; }
    .bar-print-info .bpi-dates  { font-family:'DM Mono',monospace; font-size:7.5px; color:rgba(255,255,255,0.9); margin-top:1px; }
    .bar-print-info .bpi-budget { font-family:'DM Mono',monospace; font-size:7.5px; font-weight:600; color:rgba(255,255,255,0.95); margin-top:1px; }
    .bar-print-info .bpi-deps   { font-family:'DM Mono',monospace; font-size:7px; color:rgba(255,255,255,0.7); margin-top:1px; white-space:normal; word-break:break-word; }
    .g-quarter { color:#2563eb !important; }
    .g-month   { color:#4b5563 !important; }
    .g-label-hdr { color:#6b7280 !important; background:#fff !important; }
    #dep-svg path { opacity:0.6 !important; }
    #dep-svg polygon { opacity:0.7 !important; }
    @page { size: A3 landscape; margin: 12mm 10mm; }
  }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-title">
    <h1>CAMCIS <span>AI</span></h1>
    <div class="subtitle">Plan de mise en ≈ìuvre ‚Äî Gantt interactif</div>
  </div>
  <div class="topbar-pills">
    <div class="pill highlight">Sc√©nario : <b id="sum-scenario">‚Äî</b></div>
    <div class="pill">Dur√©e : <b id="sum-dur">‚Äî</b></div>
    <div class="pill">Budget : <b id="sum-bud">‚Äî</b></div>
    <div class="pill">T√¢ches : <b id="sum-tasks">‚Äî</b></div>
    <div class="pill green" title="Am√©lioration des recettes douani√®res cumul√©e sur les t√¢ches actives">
      Recettes : <b id="sum-rev">‚Äî</b>
    </div>
    <div class="pill orange" title="Heures-employ√© √©conomis√©es par an sur les t√¢ches actives">
      Charge √©vit√©e : <b id="sum-work">‚Äî</b>
    </div>
    <div class="pill teal" title="R√©duction de la dur√©e de transit portuaire cumul√©e sur les t√¢ches actives">
      Transit : <b id="sum-transit">‚Äî</b>
    </div>
  </div>
  <div class="topbar-actions">
    <button class="btn btn-ghost" id="theme-btn" onclick="toggleTheme()" title="Basculer jour/nuit">üåô</button>
    <button class="btn btn-ghost" onclick="window.print()" title="Imprimer">üñ® Imprimer</button>
    <button class="btn btn-ghost" id="json-btn" onclick="toggleJson()">{ } JSON</button>
    <button class="btn btn-ghost" onclick="addGroup()">+ Groupe</button>
  </div>
</div>

<!-- SCENARIO TABS -->
<div class="scenario-bar" id="scenario-bar"></div>

<!-- GROUP TOGGLES -->
<div class="controls" id="group-controls"></div>

<!-- ADD BAR -->
<div class="add-bar">
  <span class="add-label">Ajouter :</span>
  <input type="text"   id="inp-name"   placeholder="Nom de la t√¢che" style="width:155px;" />
  <select id="inp-group" style="width:155px;"></select>
  <input type="number" id="inp-start"  placeholder="Mois d√©but" min="1" style="width:85px;" />
  <input type="number" id="inp-dur"    placeholder="Dur√©e (mois)" min="1" style="width:90px;" />
  <input type="number" id="inp-budget" placeholder="Budget FCFA" min="0" style="width:120px;" />
  <input type="text"   id="inp-deps"   placeholder="D√©p. IDs: 1,3" style="width:110px;" />
  <input type="text"   id="inp-ref"    placeholder="R√©f. ¬ß2.2" style="width:80px;" />
  <button class="btn btn-primary" onclick="addTask()">+ Ajouter</button>
</div>

<!-- JSON PANEL -->
<div class="json-panel" id="json-panel">
  <div class="json-panel-hdr">
    <span>// Modifiez le JSON puis appliquez ‚Äî Ctrl+S pour sauvegarder</span>
    <button class="btn btn-ghost" onclick="applyJson()" style="font-size:11px;padding:5px 11px;">‚úì Appliquer</button>
    <button class="btn btn-ghost" onclick="toggleJson()" style="font-size:11px;padding:5px 11px;">‚úï</button>
  </div>
  <div class="json-err" id="json-err"></div>
  <textarea id="json-editor" spellcheck="false"></textarea>
</div>

<!-- GANTT -->
<div class="gantt-scroll" id="gantt-scroll">
  <div class="gantt-inner" id="gantt-inner">
    <div class="gantt-header">
      <div class="g-label-hdr">T√¢ches / Groupes</div>
      <div class="g-timeline-hdr">
        <div class="g-quarters" id="g-quarters"></div>
        <div class="g-months"   id="g-months"></div>
      </div>
    </div>
    <div class="gantt-body" id="gantt-body">
      <svg id="dep-svg"></svg>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PALETTE & SCENARIO BADGE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const PALETTE = ['#4f9ef8','#f77f5f','#50d08c','#a78bfa','#f9c74f','#38bdf8','#fb923c','#f472b6','#34d399','#e879f9'];

const SC_BADGE = {
  A: { label:'PILOTE',        bg:'#1a2840', c:'#4f9ef8' },
  B: { label:'INT√âGRATION',   bg:'#1a2e20', c:'#50d08c' },
  C: { label:'INSTITUTIONNEL',bg:'#2e2a14', c:'#f9c74f' },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROJECT DATA  (CAMCIS v5 ‚Äî Livrable 2 Chapitre 2)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let project = {
  "name": "CAMCIS ‚Äî Int√©gration de l'IA",
  "subtitle": "Livrable 2 ‚Äî Chapitre 2 : Sp√©cifications Fonctionnelles",
  "version": "2.0",
  "timeUnit": "mois",
  "budgetUnit": "FCFA",
  "startDate": "2026-03-01",
  "activeScenario": "A",
  "scenarios": [
    {
      "id": "A",
      "name": "Pilote IA cibl√©",
      "subtitle": "Gouvernance renforc√©e + Scoring risque pilote (2 bureaux) ‚Äî Mois 1 √† 9",
      "duration": 9,
      "budget": 116000000,
      "taskIds": [
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10
      ],
      "label": "Sc√©nario A"
    },
    {
      "id": "B",
      "name": "Int√©gration modulaire progressive",
      "subtitle": "A + MLOps + Extension nationale + LLM + OCR + API B2B + Chatbot ‚Äî Mois 1 √† 24",
      "duration": 24,
      "budget": 461500000,
      "taskIds": [
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12,
        13,
        14,
        15,
        16,
        17,
        18,
        19,
        20
      ],
      "label": "Sc√©nario B"
    },
    {
      "id": "C",
      "name": "Plateforme IA institutionnelle",
      "subtitle": "A + B + Centre Excellence + Tous modules IA + Interop√©rabilit√© CEMAC ‚Äî Mois 1 √† 48",
      "duration": 48,
      "budget": 805500000,
      "taskIds": [
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12,
        13,
        14,
        15,
        16,
        17,
        18,
        19,
        20,
        21,
        22,
        23,
        24,
        25,
        26,
        27,
        28,
        29,
        30,
        31,
        32,
        33
      ],
      "label": "Sc√©nario C"
    }
  ],
  "groups": [
    {
      "id": 1,
      "name": "Module 1 ‚Äî Gouvernance, Donn√©es & Conformit√©",
      "ref": "¬ß 2.2.1",
      "color": "#2563A8",
      "visible": true
    },
    {
      "id": 2,
      "name": "Module 2 ‚Äî Infrastructure & MLOps",
      "ref": "¬ß 2.2.2",
      "color": "#4A7FC1",
      "visible": true
    },
    {
      "id": 3,
      "name": "Module 3 ‚Äî D√©tection de fraudes & Risques",
      "ref": "¬ß 2.2.3",
      "color": "#C55A11",
      "visible": true
    },
    {
      "id": 4,
      "name": "Module 4 ‚Äî Efficacit√© op√©rationnelle",
      "ref": "¬ß 2.2.4",
      "color": "#7030A0",
      "visible": true
    },
    {
      "id": 5,
      "name": "Module 5 ‚Äî Service aux usagers",
      "ref": "¬ß 2.2.5",
      "color": "#1D6060",
      "visible": true
    },
    {
      "id": 6,
      "name": "Module 6 ‚Äî Pilotage strat√©gique & Centre Excellence",
      "ref": "¬ß 2.2.6",
      "color": "#7F6000",
      "visible": true
    },
    {
      "id": 7,
      "name": "Module 7 ‚Äî Interop√©rabilit√© CEMAC",
      "ref": "¬ß 2.2.7",
      "color": "#00695C",
      "visible": true
    }
  ],
  "tasks": [
    {
      "id": 1,
      "groupId": 1,
      "ref": "¬ß 2.2.1.1",
      "taskCode": "T-1.1",
      "name": "Comit√© pilotage & CDO permanent",
      "start": 1,
      "duration": 2,
      "budget": 15000000,
      "deps": [],
      "note": "CDO √† temps plein d√®s M1 ‚Äî non un consultant ponctuel.",
      "scenario": "A"
    },
    {
      "id": 2,
      "groupId": 1,
      "ref": "¬ß 2.2.1.2",
      "taskCode": "T-1.2",
      "name": "Gouvernance donn√©es & dictionnaire",
      "start": 1,
      "duration": 3,
      "budget": 12000000,
      "deps": [
        1
      ],
      "note": "Data stewards par bureau + dictionnaire donn√©es complet",
      "scenario": "A",
      "revenueImpactPct": 0.1,
      "workloadSavingHoursPerYear": 2000
    },
    {
      "id": 3,
      "groupId": 1,
      "ref": "¬ß 2.2.1.3",
      "taskCode": "T-1.3",
      "name": "Charte √©thique IA & conformit√© Loi 2024/017",
      "start": 2,
      "duration": 1,
      "budget": 5000000,
      "deps": [
        1
      ],
      "note": "Charte √©thique + conformit√© loi camerounaise 2024/017",
      "scenario": "A"
    },
    {
      "id": 4,
      "groupId": 2,
      "ref": "¬ß 2.2.2.1",
      "taskCode": "T-2.1",
      "name": "Infrastructure dev/test & env. data science",
      "start": 2,
      "duration": 2,
      "budget": 12000000,
      "deps": [
        1
      ],
      "note": "JupyterHub, Docker, Git, r√©seau isol√© prod/dev",
      "scenario": "A"
    },
    {
      "id": 5,
      "groupId": 2,
      "ref": "¬ß 2.2.2.2",
      "taskCode": "T-2.2",
      "name": "Pipelines ETL ‚Äî donn√©es historiques CAMCIS",
      "start": 3,
      "duration": 2,
      "budget": 7000000,
      "deps": [
        4
      ],
      "note": "5 ans de donn√©es historiques, 40+ variables, Airflow + pandas",
      "scenario": "A",
      "revenueImpactPct": 0.05,
      "workloadSavingHoursPerYear": 800
    },
    {
      "id": 6,
      "groupId": 3,
      "ref": "¬ß 2.2.3.1",
      "taskCode": "T-3.1",
      "name": "Feature engineering & scoring risque ML",
      "start": 4,
      "duration": 3,
      "budget": 27000000,
      "deps": [
        5
      ],
      "note": "XGBoost/Random Forest, 40+ variables, back-testing 5 ans",
      "scenario": "A",
      "revenueImpactPct": 1.0,
      "workloadSavingHoursPerYear": 5000
    },
    {
      "id": 7,
      "groupId": 3,
      "ref": "¬ß 2.2.3.2",
      "taskCode": "T-3.2",
      "name": "XAI (SHAP/LIME) & interface agents",
      "start": 6,
      "duration": 2,
      "budget": 12000000,
      "deps": [
        6
      ],
      "note": "Chaque d√©cision tra√ßable et auditable. Droit de recours garanti",
      "scenario": "A",
      "revenueImpactPct": 0.25,
      "workloadSavingHoursPerYear": 2000
    },
    {
      "id": 8,
      "groupId": 3,
      "ref": "¬ß 2.2.3.3",
      "taskCode": "T-3.3",
      "name": "D√©ploiement pilote ‚Äî Port Douala & fronti√®re",
      "start": 7,
      "duration": 2,
      "budget": 9000000,
      "deps": [
        7
      ],
      "note": "2 bureaux pilotes, 500+ d√©clarations/jour scor√©es",
      "scenario": "A",
      "revenueImpactPct": 0.4,
      "workloadSavingHoursPerYear": 3000
    },
    {
      "id": 9,
      "groupId": 1,
      "ref": "¬ß 2.2.1.4",
      "taskCode": "T-1.4a",
      "name": "Formation agents pilotes & conduite changement (Sc.A)",
      "start": 5,
      "duration": 3,
      "budget": 11000000,
      "deps": [
        3
      ],
      "note": "Formation agents 2 bureaux pilotes. Taux adoption cible >70 %",
      "scenario": "A",
      "workloadSavingHoursPerYear": 1500
    },
    {
      "id": 10,
      "groupId": 6,
      "ref": "¬ß 2.2.6.1",
      "taskCode": "T-6.1",
      "name": "√âvaluation KPIs pilote & rapport Go/No-Go",
      "start": 9,
      "duration": 1,
      "budget": 6000000,
      "deps": [
        8,
        9
      ],
      "note": "D√©clencheur Sc√©nario B. ROI Sc.A document√©",
      "scenario": "A"
    },
    {
      "id": 11,
      "groupId": 2,
      "ref": "¬ß 2.2.2.3",
      "taskCode": "T-2.3",
      "name": "Plateforme MLOps ‚Äî MLflow + Kubeflow",
      "start": 10,
      "duration": 3,
      "budget": 30000000,
      "deps": [
        5,
        10
      ],
      "note": "Versioning mod√®les, CI/CD, monitoring drift. D√©ploiement 24-48h",
      "scenario": "B",
      "workloadSavingHoursPerYear": 3000
    },
    {
      "id": 12,
      "groupId": 2,
      "ref": "¬ß 2.2.2.4",
      "taskCode": "T-2.4",
      "name": "Serveurs GPU & infrastructure production HA",
      "start": 10,
      "duration": 2,
      "budget": 22500000,
      "deps": [
        10
      ],
      "note": "2√ó NVIDIA A100, SAN 10 To, Kubernetes HA, disponibilit√© 99,5 %",
      "scenario": "B"
    },
    {
      "id": 13,
      "groupId": 3,
      "ref": "¬ß 2.2.3.4",
      "taskCode": "T-3.4",
      "name": "Extension nationale ‚Äî scoring risque tous bureaux",
      "start": 12,
      "duration": 4,
      "budget": 35000000,
      "deps": [
        11,
        8
      ],
      "note": "100 % bureaux couverts M15. R√©entra√Ænement mensuel automatique",
      "scenario": "B",
      "revenueImpactPct": 1.3,
      "workloadSavingHoursPerYear": 8000
    },
    {
      "id": 14,
      "groupId": 4,
      "ref": "¬ß 2.2.4.1",
      "taskCode": "T-4.1",
      "name": "Classification tarifaire assist√©e ‚Äî LLM souverain",
      "start": 13,
      "duration": 5,
      "budget": 45000000,
      "deps": [
        11
      ],
      "note": "Llama 3 / Mistral local. Code SH + justification textuelle. -50 % erreurs",
      "scenario": "B",
      "revenueImpactPct": 0.15,
      "workloadSavingHoursPerYear": 12000
    },
    {
      "id": 15,
      "groupId": 4,
      "ref": "¬ß 2.2.4.2",
      "taskCode": "T-4.2",
      "name": "Fine-tuning LLM souverain sur corpus douanier CEMAC",
      "start": 15,
      "duration": 3,
      "budget": 20000000,
      "deps": [
        14
      ],
      "note": "LoRA + RAG sur corpus DGD/CEMAC. Pr√©requis chatbot et classification",
      "scenario": "B",
      "revenueImpactPct": 0.05
    },
    {
      "id": 16,
      "groupId": 4,
      "ref": "¬ß 2.2.4.3",
      "taskCode": "T-4.3",
      "name": "V√©rification documentaire OCR & NLP",
      "start": 14,
      "duration": 4,
      "budget": 42000000,
      "deps": [
        11
      ],
      "note": "Tesseract/Textract + BERT. -50 √† 70 % temps contr√¥le documentaire",
      "scenario": "B",
      "revenueImpactPct": 0.1,
      "workloadSavingHoursPerYear": 15000,
      "transitReductionPct": 1.5
    },
    {
      "id": 17,
      "groupId": 4,
      "ref": "¬ß 2.2.4.5",
      "taskCode": "T-4.5",
      "name": "API B2B ‚Äî Int√©gration op√©rateurs & ERP [AVANC√âE]",
      "start": 18,
      "duration": 4,
      "budget": 35000000,
      "deps": [
        16,
        13
      ],
      "note": "AVANC√âE Sc.C ‚Üí Sc.B. REST + webhooks. 10+ OEA pilotes",
      "scenario": "B",
      "revenueImpactPct": 0.2,
      "workloadSavingHoursPerYear": 10000,
      "transitReductionPct": 3.0
    },
    {
      "id": 18,
      "groupId": 5,
      "ref": "¬ß 2.2.5.1",
      "taskCode": "T-5.1",
      "name": "Chatbot multilingue 24/7 ‚Äî EPT/IPT & mobile [AVANC√â]",
      "start": 17,
      "duration": 5,
      "budget": 50000000,
      "deps": [
        15,
        13
      ],
      "note": "AVANC√â Sc.C ‚Üí Sc.B. RAG + LLM fine-tun√©. FR/EN/langues locales. 50-70 % demandes autonomes",
      "scenario": "B",
      "workloadSavingHoursPerYear": 6000,
      "transitReductionPct": 1.0
    },
    {
      "id": 19,
      "groupId": 1,
      "ref": "¬ß 2.2.1.5",
      "taskCode": "T-1.5",
      "name": "Programme acad√©mique ENSP ‚Äî Partenariat Polytechnique Yaound√©",
      "start": 13,
      "duration": 6,
      "budget": 13000000,
      "deps": [
        13
      ],
      "note": "Convention ENSP : stages data science, th√®ses appliqu√©es, pipeline recrutement CEI",
      "scenario": "B"
    },
    {
      "id": 20,
      "groupId": 6,
      "ref": "¬ß 2.2.6.2",
      "taskCode": "T-6.2",
      "name": "√âvaluation √©tendue & audit √©thique/ROI Sc√©nario B",
      "start": 23,
      "duration": 2,
      "budget": 11000000,
      "deps": [
        17,
        18
      ],
      "note": "D√©clencheur Sc√©nario C. ROI r√©el Sc.B document√© vs estim√©",
      "scenario": "B"
    },
    {
      "id": 21,
      "groupId": 6,
      "ref": "¬ß 2.2.6.3",
      "taskCode": "T-6.3",
      "name": "Centre d'Excellence IA ‚Äî Cr√©ation & recrutement",
      "start": 25,
      "duration": 6,
      "budget": 40000000,
      "deps": [
        20
      ],
      "note": "8-12 experts locaux. Budget r√©current post-M48 : 110-140M FCFA/an",
      "scenario": "C",
      "workloadSavingHoursPerYear": 5000
    },
    {
      "id": 22,
      "groupId": 4,
      "ref": "¬ß 2.2.4.4",
      "taskCode": "T-4.4",
      "name": "Assistance intelligente saisie des d√©clarations",
      "start": 27,
      "duration": 3,
      "budget": 30000000,
      "deps": [
        16
      ],
      "note": "Auto-compl√©tion + validation temps r√©el. -30 √† 40 % temps saisie",
      "scenario": "C",
      "revenueImpactPct": 0.05,
      "workloadSavingHoursPerYear": 8000,
      "transitReductionPct": 1.0
    },
    {
      "id": 23,
      "groupId": 4,
      "ref": "¬ß 2.2.4.6",
      "taskCode": "T-4.6",
      "name": "Automatisation d√©douanement faible risque (circuit vert)",
      "start": 27,
      "duration": 4,
      "budget": 38000000,
      "deps": [
        21
      ],
      "note": "60-70 % d√©clarations en circuit vert. Supervision humaine 10 % al√©atoire",
      "scenario": "C",
      "revenueImpactPct": 0.2,
      "workloadSavingHoursPerYear": 18000,
      "transitReductionPct": 5.0
    },
    {
      "id": 24,
      "groupId": 3,
      "ref": "¬ß 2.2.3.5",
      "taskCode": "T-3.5",
      "name": "Analyse graphes GNN ‚Äî R√©seaux frauduleux",
      "start": 28,
      "duration": 5,
      "budget": 50000000,
      "deps": [
        21
      ],
      "note": "PyTorch Geometric + Neo4j. -60 √† 70 % temps enqu√™tes r√©seaux",
      "scenario": "C",
      "revenueImpactPct": 0.35,
      "workloadSavingHoursPerYear": 6000
    },
    {
      "id": 25,
      "groupId": 5,
      "ref": "¬ß 2.2.5.2",
      "taskCode": "T-5.2",
      "name": "Gestion intelligente r√©clamations & contentieux",
      "start": 33,
      "duration": 3,
      "budget": 25000000,
      "deps": [
        18
      ],
      "note": "Tri NLP + case-based reasoning. -50 √† 70 % d√©lai traitement",
      "scenario": "C",
      "workloadSavingHoursPerYear": 4000,
      "transitReductionPct": 0.5
    },
    {
      "id": 26,
      "groupId": 6,
      "ref": "¬ß 2.2.6.4",
      "taskCode": "T-6.4",
      "name": "Pr√©visions avanc√©es recettes & flux commerciaux",
      "start": 32,
      "duration": 4,
      "budget": 35000000,
      "deps": [
        21
      ],
      "note": "LSTM + Prophet. Horizon 12 mois. +30 √† 45 % pr√©cision budg√©taire",
      "scenario": "C",
      "revenueImpactPct": 0.1,
      "workloadSavingHoursPerYear": 3000
    },
    {
      "id": 27,
      "groupId": 6,
      "ref": "¬ß 2.2.6.5",
      "taskCode": "T-6.5",
      "name": "Simulation impact mesures douani√®res",
      "start": 35,
      "duration": 4,
      "budget": 30000000,
      "deps": [
        26
      ],
      "note": "Monte Carlo + r√©seaux bay√©siens. -50 √† 70 % risque d√©cisions contre-productives",
      "scenario": "C",
      "revenueImpactPct": 0.1,
      "workloadSavingHoursPerYear": 2000
    },
    {
      "id": 28,
      "groupId": 7,
      "ref": "¬ß 2.2.7.1",
      "taskCode": "T-7.1",
      "name": "Interop√©rabilit√© SYDONIA++ & douanes CEMAC",
      "start": 30,
      "duration": 4,
      "budget": 18000000,
      "deps": [
        23,
        17
      ],
      "note": "MODULE. √âchange manifestes + alertes risque CEMAC. Standard WCO SAFE",
      "scenario": "C",
      "revenueImpactPct": 0.15,
      "transitReductionPct": 2.0
    },
    {
      "id": 29,
      "groupId": 7,
      "ref": "¬ß 2.2.7.2",
      "taskCode": "T-7.2",
      "name": "Int√©gration √©cosyst√®me portuaire ‚Äî compagnies maritimes",
      "start": 33,
      "duration": 3,
      "budget": 12000000,
      "deps": [
        28
      ],
      "note": "Pre-Arrival Processing, Maersk/MSC/CMA-CGM. -15 √† 20 % temps s√©jour conteneurs",
      "scenario": "C",
      "transitReductionPct": 5.0
    },
    {
      "id": 30,
      "groupId": 6,
      "ref": "¬ß 2.2.6.6",
      "taskCode": "T-6.6",
      "name": "D√©mocratisation analyse donn√©es ‚Äî NL vers SQL/Python",
      "start": 38,
      "duration": 4,
      "budget": 28000000,
      "deps": [
        21
      ],
      "note": "Text-to-SQL sur LLM fine-tun√©. √ó5 √† 10 agents capables d'analyser sans IT",
      "scenario": "C",
      "workloadSavingHoursPerYear": 8000
    },
    {
      "id": 31,
      "groupId": 3,
      "ref": "¬ß 2.2.3.6",
      "taskCode": "T-3.6",
      "name": "Vision par ordinateur ‚Äî Phase EXP√âRIMENTALE (1-2 scanners)",
      "start": 42,
      "duration": 4,
      "budget": 30000000,
      "deps": [
        28
      ],
      "note": "Pilote 1-2 scanners Douala uniquement. Industrialisation = budget additionnel s√©par√©",
      "scenario": "C",
      "revenueImpactPct": 0.1,
      "workloadSavingHoursPerYear": 2000
    },
    {
      "id": 32,
      "groupId": 6,
      "ref": "¬ß 2.2.6.7",
      "taskCode": "T-6.7",
      "name": "Audits √©thique semestriels & rapport final programme",
      "start": 44,
      "duration": 3,
      "budget": 27000000,
      "deps": [
        30,
        27,
        31
      ],
      "note": "Audits Fairness Indicators. Rapport final DGD M46. Plan phase 2 M48",
      "scenario": "C"
    },
    {
      "id": 33,
      "groupId": 3,
      "ref": "¬ß 2.2.3.7",
      "taskCode": "T-3.7",
      "name": "R√©ponse adaptative chocs commerciaux",
      "start": 40,
      "duration": 4,
      "budget": 15000000,
      "deps": [
        27
      ],
      "note": "Drift detection + recalibration automatique <48h. Stabilit√© KPIs en p√©riode perturb√©e",
      "scenario": "C",
      "revenueImpactPct": 0.05,
      "workloadSavingHoursPerYear": 500
    }
  ],
  "budgetSummary": {
    "scenarioA": 116000000,
    "scenarioB_additionnel": 345500000,
    "scenarioC_additionnel": 344000000,
    "total": 805500000,
    "note": "Gouvernance renforc√©e (80M FCFA), Module 7 Interop√©rabilit√© CEMAC (30M), fine-tuning LLM (20M). Vision ordinateur cadr√©e en phase exp√©rimentale (30M)."
  },
  "kpiSection": "¬ß 2.3",
  "budgetSection": "¬ß 2.4"
};

let nextTaskId  = Math.max(...project.tasks.map(t => t.id))  + 1;
let nextGroupId = Math.max(...project.groups.map(g => g.id)) + 1;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCENARIO HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getActiveScenario() {
  return project.scenarios.find(s => s.id === project.activeScenario) || project.scenarios[0];
}

function scenarioStats(sc) {
  const ids = new Set(sc.taskIds);
  const scTasks = project.tasks.filter(t => ids.has(t.id));
  const budget  = scTasks.reduce((s, t) => s + t.budget, 0);
  const sched   = computeSchedule(scTasks);
  let minS = Infinity, maxE = 0;
  scTasks.forEach(t => {
    const s = sched[t.id] || t.start;
    if (s < minS) minS = s;
    const e = s + t.duration;
    if (e > maxE) maxE = e;
  });
  const dur = scTasks.length ? (maxE - minS) : 0;
  return { budget, dur, count: scTasks.length };
}

// ‚îÄ‚îÄ Compute cumulative metrics for a set of visible tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeMetrics(visibleTasks) {
  let rev = 0, work = 0, transit = 0;
  visibleTasks.forEach(t => {
    if (t.revenueImpactPct       != null) rev     += t.revenueImpactPct;
    if (t.workloadSavingHoursPerYear != null) work += t.workloadSavingHoursPerYear;
    if (t.transitReductionPct    != null) transit  += t.transitReductionPct;
  });
  return { rev, work, transit };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VISIBILITY  (scenario filter + group toggle + dep pull-in)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getVisibleTasks() {
  const sc      = getActiveScenario();
  const scIds   = new Set(sc.taskIds);
  const visGids = new Set(project.groups.filter(g => g.visible).map(g => g.id));

  const direct = new Set(
    project.tasks.filter(t => scIds.has(t.id) && visGids.has(t.groupId)).map(t => t.id)
  );

  // Pull in deps transitively
  const required = new Set(direct);
  let changed = true;
  while (changed) {
    changed = false;
    project.tasks.forEach(t => {
      if (required.has(t.id)) {
        (t.deps || []).forEach(d => {
          if (!required.has(d) && scIds.has(d)) { required.add(d); changed = true; }
        });
      }
    });
  }
  return project.tasks.filter(t => required.has(t.id));
}

function isBorrowed(taskId) {
  const visGids = new Set(project.groups.filter(g => g.visible).map(g => g.id));
  const t = project.tasks.find(t => t.id === taskId);
  return t && !visGids.has(t.groupId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEPENDENCY-AWARE SCHEDULING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function computeSchedule(visibleTasks) {
  const vtById = {};
  visibleTasks.forEach(t => { vtById[t.id] = t; });
  const scheduled = {}, visited = {};

  function solve(id) {
    if (scheduled[id] !== undefined) return scheduled[id];
    if (visited[id]) { scheduled[id] = 1; return 1; }
    visited[id] = true;
    const task = vtById[id];
    if (!task) { scheduled[id] = 1; return 1; }
    const activeDeps = (task.deps || []).filter(d => vtById[d] !== undefined);
    if (!activeDeps.length) { scheduled[id] = task.start; return task.start; }
    let depEnd = 0;
    activeDeps.forEach(depId => {
      const depStart = solve(depId);
      const end = depStart + (vtById[depId] ? vtById[depId].duration : 0);
      if (end > depEnd) depEnd = end;
    });
    scheduled[id] = depEnd;
    return depEnd;
  }
  visibleTasks.forEach(t => solve(t.id));
  return scheduled;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMELINE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getTotalMonths(schedule, vt) {
  if (!vt || !vt.length) return 18;
  let mx = 0;
  vt.forEach(t => { const e = (schedule[t.id] || t.start) + t.duration; if (e > mx) mx = e; });
  return Math.max(mx + 1, 12);
}

function monthLabel(m) {
  const base = new Date(project.startDate);
  const d = new Date(base.getFullYear(), base.getMonth() + m - 1, 1);
  return d.toLocaleString('fr-FR', { month: 'short' }).replace('.', '').toUpperCase();
}

function getQuarters(totalMonths) {
  const qs = []; let cur = null, cnt = 0;
  for (let m = 1; m <= totalMonths; m++) {
    const base = new Date(project.startDate);
    const d = new Date(base.getFullYear(), base.getMonth() + m - 1, 1);
    const q = `T${Math.ceil((d.getMonth() + 1) / 3)} ${d.getFullYear()}`;
    if (q !== cur) { if (cur) qs.push({ label: cur, count: cnt }); cur = q; cnt = 1; } else cnt++;
  }
  if (cur) qs.push({ label: cur, count: cnt });
  return qs;
}

function formatBudget(n) {
  if (n >= 1e9) return (n / 1e9).toLocaleString('fr-FR', { maximumFractionDigits: 2 }) + ' Md FCFA';
  if (n >= 1e6) return (n / 1e6).toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' M FCFA';
  return n.toLocaleString('fr-FR') + ' FCFA';
}

function formatWork(h) {
  if (h >= 1000) return (h / 1000).toLocaleString('fr-FR', { maximumFractionDigits: 1 }) + ' k h/an';
  return h.toLocaleString('fr-FR') + ' h/an';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER ENTRY POINT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function render() {
  const vt       = getVisibleTasks();
  const schedule = computeSchedule(vt);
  renderScenarioTabs();
  renderGroupControls();
  renderSummary(schedule, vt);
  renderGantt(schedule, vt);
}

// ‚îÄ‚îÄ Scenario tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderScenarioTabs() {
  const bar = document.getElementById('scenario-bar');
  bar.innerHTML = '<span class="scenario-bar-label">Sc√©narios</span>';

  project.scenarios.forEach(sc => {
    const stats    = scenarioStats(sc);
    const scTasks  = project.tasks.filter(t => new Set(sc.taskIds).has(t.id));
    const m        = computeMetrics(scTasks);
    const isActive = sc.id === project.activeScenario;
    const badge    = SC_BADGE[sc.id] || { label: sc.id, bg: '#222', c: '#888' };

    const tab = document.createElement('div');
    tab.className = 'scenario-tab' + (isActive ? ' active' : '');

    // Build KPI mini-badges for the tab
    const kpiChips = [];
    if (m.rev     > 0) kpiChips.push(`<span class="sc-kpi" style="background:#4ade8018;color:#4ade80">+${m.rev.toFixed(1)}% recettes</span>`);
    if (m.work    > 0) kpiChips.push(`<span class="sc-kpi" style="background:#fb923c18;color:#fb923c">${formatWork(m.work)}</span>`);
    if (m.transit > 0) kpiChips.push(`<span class="sc-kpi" style="background:#2dd4bf18;color:#2dd4bf">-${m.transit.toFixed(1)}% transit</span>`);

    tab.innerHTML = `
      <div class="sc-letter">${sc.label || sc.id}</div>
      <div class="sc-name">${sc.name}</div>
      <div class="sc-subtitle">${sc.subtitle || ''}</div>
      <div class="sc-meta">${stats.dur} mois ¬∑ ${formatBudget(stats.budget)} ¬∑ ${stats.count} t√¢ches</div>
      ${kpiChips.length ? `<div class="sc-kpis">${kpiChips.join('')}</div>` : ''}
      <span class="sc-badge" style="background:${badge.bg};color:${badge.c}">${badge.label}</span>`;
    tab.onclick = () => { project.activeScenario = sc.id; render(); };
    bar.appendChild(tab);
  });
}

// ‚îÄ‚îÄ Group toggles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGroupControls() {
  const ctrl  = document.getElementById('group-controls');
  ctrl.innerHTML = '<span class="ctrl-label">Filtrer par groupe :</span>';

  const sc     = getActiveScenario();
  const scIds  = new Set(sc.taskIds);
  const relevantGroups = project.groups.filter(g =>
    project.tasks.some(t => t.groupId === g.id && scIds.has(t.id))
  );

  relevantGroups.forEach(g => {
    const btn = document.createElement('div');
    btn.className = 'group-toggle' + (g.visible ? '' : ' off');
    btn.style.borderColor = g.color;
    btn.style.background  = g.visible ? g.color + '22' : 'transparent';
    btn.style.color       = g.visible ? g.color : 'var(--text-muted)';
    btn.innerHTML = `<span class="dot" style="background:${g.color}"></span>${g.name}`;
    btn.onclick = () => { g.visible = !g.visible; render(); };
    ctrl.appendChild(btn);
  });

  const sel = document.getElementById('inp-group');
  sel.innerHTML = '';
  project.groups.forEach(g => {
    const o = document.createElement('option');
    o.value = g.id; o.textContent = g.name;
    sel.appendChild(o);
  });
}

// ‚îÄ‚îÄ Summary pills (topbar) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSummary(schedule, vt) {
  const sc   = getActiveScenario();
  const bud  = vt.reduce((s, t) => s + t.budget, 0);
  let minS = Infinity, maxE = 0;
  vt.forEach(t => {
    const s = schedule[t.id] || t.start;
    if (s < minS) minS = s;
    const e = s + t.duration;
    if (e > maxE) maxE = e;
  });
  const dur  = vt.length ? (maxE - minS) : 0;
  const visG = project.groups.filter(g => g.visible && vt.some(t => t.groupId === g.id));

  // Metrics computed ONLY on visible tasks (respects group filters too)
  const m = computeMetrics(vt);

  document.getElementById('sum-scenario').textContent = sc.name;
  document.getElementById('sum-dur').textContent      = dur  ? `${dur} mois` : '‚Äî';
  document.getElementById('sum-bud').textContent      = bud  ? formatBudget(bud) : '‚Äî';
  document.getElementById('sum-tasks').textContent    = vt.length;
  document.getElementById('sum-rev').textContent      = m.rev     > 0 ? `+${m.rev.toFixed(1)} %`      : '‚Äî';
  document.getElementById('sum-work').textContent     = m.work    > 0 ? formatWork(m.work)             : '‚Äî';
  document.getElementById('sum-transit').textContent  = m.transit > 0 ? `-${m.transit.toFixed(1)} %`   : '‚Äî';
}

// ‚îÄ‚îÄ Gantt chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGantt(schedule, vt) {
  const body = document.getElementById('gantt-body');
  const svg  = document.getElementById('dep-svg');
  Array.from(body.children).forEach(c => { if (c !== svg) body.removeChild(c); });
  svg.innerHTML = '';

  const totalM = getTotalMonths(schedule, vt);
  renderHeader(totalM);

  if (!vt.length) {
    const em = document.createElement('div');
    em.className = 'empty';
    em.textContent = 'Aucune t√¢che visible pour ce sc√©nario.';
    body.insertBefore(em, svg);
    return;
  }

  const taskRowMap = {};
  let yOff = 0;
  const visGroups = project.groups.filter(g => vt.some(t => t.groupId === g.id));

  visGroups.forEach(group => {
    const gTasks   = vt.filter(t => t.groupId === group.id);
    if (!gTasks.length) return;

    const gBud      = gTasks.reduce((s, t) => s + t.budget, 0);
    const groupIsOff = !group.visible;

    // Group header row
    const ghRow = document.createElement('div');
    ghRow.className = 'group-hdr-row';
    ghRow.style.opacity = groupIsOff ? '0.5' : '1';

    const ghLbl = document.createElement('div');
    ghLbl.className = 'group-hdr-lbl';
    ghLbl.innerHTML = `
      <span class="gcolor" style="background:${group.color}"></span>
      <span style="color:${group.color};flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${group.name}">${group.name}</span>
      ${groupIsOff ? '<span style="font-size:8px;color:var(--accent);background:var(--surface3);border:1px solid var(--accent);border-radius:3px;padding:1px 5px;margin-right:4px;flex-shrink:0;">REQUIS</span>' : ''}
      <span class="g-meta">${gTasks.length} t√¢che${gTasks.length > 1 ? 's' : ''} ¬∑ ${formatBudget(gBud)}</span>`;

    const ghTl = document.createElement('div'); ghTl.className = 'group-hdr-tl';
    const tint = document.createElement('div'); tint.className = 'group-tint'; tint.style.background = group.color;
    ghTl.appendChild(tint);
    ghRow.appendChild(ghLbl); ghRow.appendChild(ghTl);
    body.insertBefore(ghRow, svg);
    yOff += 38;

    // Task rows
    gTasks.forEach(task => {
      const borrowed  = isBorrowed(task.id);
      const effStart  = schedule[task.id] || task.start;
      const sf = (effStart - 1) / totalM;
      const ef = (effStart - 1 + task.duration) / totalM;

      const row = document.createElement('div');
      row.className = 'task-row';

      const lbl = document.createElement('div');
      lbl.className = 'task-lbl';
      lbl.innerHTML = `
        <span class="task-id-badge">#${task.id}</span>
        <span class="task-nm" title="${task.name}">${task.name}</span>
        ${task.ref ? `<span class="task-ref">${task.ref}</span>` : ''}
        ${borrowed  ? '<span class="borrowed-badge">requis</span>' : ''}
        <span class="task-dur-lbl">M${effStart}+${task.duration}</span>
        <button class="task-del" onclick="deleteTask(${task.id})" title="Supprimer">‚úï</button>`;

      const tl   = document.createElement('div'); tl.className = 'task-tl';
      const grid = document.createElement('div'); grid.className = 'grid-ov';
      for (let i = 0; i < totalM; i++) {
        const gc = document.createElement('div'); gc.className = 'grid-col'; grid.appendChild(gc);
      }
      tl.appendChild(grid);

      const bar = document.createElement('div');
      bar.className = 'task-bar';
      bar.style.left       = (sf * 100) + '%';
      bar.style.width      = Math.max((ef - sf) * 100, 0.3) + '%';
      bar.style.background = group.color;
      bar.style.opacity    = borrowed ? '0.5' : '1';

      const depNames = (task.deps || []).map(d => {
        const dt = project.tasks.find(t => t.id === d);
        return dt ? ('#' + d + ' ' + dt.name) : ('#' + d);
      }).join(', ');

      bar.innerHTML =
        '<span class="bar-txt">' + task.name + '</span>' +
        '<span class="bar-print-info">' +
          '<span class="bpi-name">' + task.name + '</span>' +
          (task.ref ? '<span class="bpi-ref">' + task.ref + '</span>' : '') +
          '<span class="bpi-dates">M+' + effStart + ' ‚Üí M+' + (effStart + task.duration - 1) + ' (' + task.duration + ' mois)</span>' +
          '<span class="bpi-budget">' + formatBudget(task.budget) + '</span>' +
          (depNames ? '<span class="bpi-deps">‚Ü≥ ' + depNames + '</span>' : '') +
        '</span>';

      bar.addEventListener('mouseenter', e => showTooltip(e, task, group, effStart));
      bar.addEventListener('mousemove',  e => moveTooltip(e));
      bar.addEventListener('mouseleave', hideTooltip);
      tl.appendChild(bar);

      row.appendChild(lbl); row.appendChild(tl);
      body.insertBefore(row, svg);
      taskRowMap[task.id] = { y: yOff + 18, sf, ef, color: group.color };
      yOff += 36;
    });
  });

  // SVG dependency arrows
  const rect = document.getElementById('gantt-inner').getBoundingClientRect();
  const LW   = 360;
  const TW   = Math.max(rect.width - LW - 2, 400);
  svg.setAttribute('width',  rect.width); svg.style.width  = rect.width  + 'px';
  svg.setAttribute('height', yOff);       svg.style.height = yOff + 'px';

  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  svg.appendChild(defs);

  vt.forEach(task => {
    if (!(task.deps || []).length) return;
    const to = taskRowMap[task.id]; if (!to) return;
    task.deps.forEach((depId, di) => {
      const from = taskRowMap[depId]; if (!from) return;
      const mid  = `a${depId}_${task.id}_${di}`;
      const mk   = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
      mk.setAttribute('id', mid); mk.setAttribute('markerWidth', '7'); mk.setAttribute('markerHeight', '7');
      mk.setAttribute('refX', '6'); mk.setAttribute('refY', '3'); mk.setAttribute('orient', 'auto');
      const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      poly.setAttribute('points', '0 0, 7 3, 0 6');
      poly.setAttribute('fill', from.color); poly.setAttribute('opacity', '0.7');
      mk.appendChild(poly); defs.appendChild(mk);

      const x1 = LW + from.ef * TW, y1 = from.y;
      const x2 = LW + to.sf   * TW, y2 = to.y;
      const bend = Math.min(50, Math.abs(x2 - x1) * 0.45 + 10);

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M ${x1} ${y1} C ${x1+bend} ${y1}, ${x2-bend} ${y2}, ${x2} ${y2}`);
      path.setAttribute('stroke', from.color); path.setAttribute('stroke-width', '1.5');
      path.setAttribute('stroke-dasharray', '5,3'); path.setAttribute('fill', 'none');
      path.setAttribute('opacity', '0.5'); path.setAttribute('marker-end', `url(#${mid})`);
      svg.appendChild(path);
    });
  });
}

function renderHeader(totalM) {
  const qEl = document.getElementById('g-quarters');
  const mEl = document.getElementById('g-months');
  qEl.innerHTML = ''; mEl.innerHTML = '';
  getQuarters(totalM).forEach(q => {
    const el = document.createElement('div');
    el.className = 'g-quarter'; el.textContent = q.label; el.style.flex = q.count;
    qEl.appendChild(el);
  });
  for (let m = 1; m <= totalM; m++) {
    const el = document.createElement('div');
    el.className = 'g-month'; el.textContent = monthLabel(m);
    mEl.appendChild(el);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOOLTIP ‚Äî enriched with task metrics
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showTooltip(ev, task, group, effStart) {
  const tt = document.getElementById('tooltip');
  const depLines = (task.deps || []).length
    ? task.deps.map(d => { const dt = project.tasks.find(t => t.id === d); return `#${d}${dt ? ' ‚Äî ' + dt.name : ''}`; }).join('<br>')
    : '‚Äî';

  // Metric rows ‚Äî only render if field exists
  let metricsHtml = '';
  if (task.revenueImpactPct != null || task.workloadSavingHoursPerYear != null || task.transitReductionPct != null) {
    metricsHtml = '<div class="tt-metrics">';
    if (task.revenueImpactPct != null)
      metricsHtml += `<div class="tt-metric rev"><span class="tm-label">üìà Am√©lioration recettes</span><span class="tm-val">+${task.revenueImpactPct.toFixed(2)} %</span></div>`;
    if (task.workloadSavingHoursPerYear != null)
      metricsHtml += `<div class="tt-metric work"><span class="tm-label">‚è± Charge √©vit√©e</span><span class="tm-val">${formatWork(task.workloadSavingHoursPerYear)}</span></div>`;
    if (task.transitReductionPct != null)
      metricsHtml += `<div class="tt-metric trnst"><span class="tm-label">üö¢ R√©duction transit</span><span class="tm-val">-${task.transitReductionPct.toFixed(1)} %</span></div>`;
    metricsHtml += '</div>';
  }

  tt.innerHTML = `
    <div class="tt-name" style="color:${group.color}">${task.name}</div>
    <div class="tt-row"><span>Groupe</span><span>${group.name}</span></div>
    <div class="tt-row"><span>D√©but</span><span>M+${effStart}</span></div>
    <div class="tt-row"><span>Dur√©e</span><span>${task.duration} mois</span></div>
    <div class="tt-row"><span>Fin</span><span>M+${effStart + task.duration - 1}</span></div>
    <div class="tt-row"><span>Budget</span><span>${formatBudget(task.budget)}</span></div>
    ${task.ref      ? `<div class="tt-section"><b>R√©f. document</b><span class="tt-ref-tag">${task.ref}</span></div>` : ''}
    ${task.taskCode ? `<div class="tt-row"><span>Code t√¢che</span><span style="color:var(--text-dim)">${task.taskCode}</span></div>` : ''}
    ${task.note     ? `<div class="tt-section"><b>Note</b>${task.note}</div>` : ''}
    ${metricsHtml}
    <div class="tt-section"><b>D√©pendances</b>${depLines}</div>`;
  tt.classList.add('show');
  moveTooltip(ev);
}
function moveTooltip(ev) {
  const tt = document.getElementById('tooltip');
  tt.style.left = Math.min(ev.clientX + 18, window.innerWidth  - 340) + 'px';
  tt.style.top  = Math.min(ev.clientY + 18, window.innerHeight - 300) + 'px';
}
function hideTooltip() { document.getElementById('tooltip').classList.remove('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function deleteTask(id) {
  project.tasks = project.tasks.filter(t => t.id !== id);
  project.tasks.forEach(t => { t.deps = (t.deps || []).filter(d => d !== id); });
  project.scenarios.forEach(sc => { sc.taskIds = sc.taskIds.filter(i => i !== id); });
  render();
}

function addTask() {
  const name   = document.getElementById('inp-name').value.trim();
  const gid    = parseInt(document.getElementById('inp-group').value);
  const start  = parseInt(document.getElementById('inp-start').value);
  const dur    = parseInt(document.getElementById('inp-dur').value);
  const budget = parseFloat(document.getElementById('inp-budget').value) || 0;
  const dRaw   = document.getElementById('inp-deps').value.trim();
  const deps   = dRaw ? dRaw.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n)) : [];
  const ref    = document.getElementById('inp-ref').value.trim();
  if (!name || !start || !dur) { alert('Nom, mois de d√©but et dur√©e sont requis.'); return; }
  const newId = nextTaskId++;
  project.tasks.push({ id: newId, groupId: gid, name, start, duration: dur, budget, deps, ref: ref || '' });
  getActiveScenario().taskIds.push(newId);
  ['inp-name', 'inp-budget', 'inp-deps', 'inp-ref'].forEach(id => { document.getElementById(id).value = ''; });
  render();
}

function addGroup() {
  const name = prompt('Nom du nouveau groupe :');
  if (!name) return;
  project.groups.push({ id: nextGroupId++, name, color: PALETTE[nextGroupId % PALETTE.length], visible: true });
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  JSON PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleJson() {
  const panel = document.getElementById('json-panel');
  const btn   = document.getElementById('json-btn');
  const open  = !panel.classList.contains('open');
  panel.classList.toggle('open', open);
  btn.classList.toggle('active', open);
  if (open) {
    document.getElementById('json-editor').value = JSON.stringify(project, null, 2);
    document.getElementById('json-err').classList.remove('show');
  }
}

function applyJson() {
  const errEl = document.getElementById('json-err');
  try {
    const p = JSON.parse(document.getElementById('json-editor').value);
    if (!Array.isArray(p.groups) || !Array.isArray(p.tasks) || !Array.isArray(p.scenarios))
      throw new Error('"groups", "tasks" et "scenarios" doivent √™tre des tableaux.');
    p.groups.forEach(g => { if (!g.id || !g.name) throw new Error('Groupe invalide'); if (g.visible == null) g.visible = true; });
    p.tasks.forEach(t  => { if (!t.id || !t.name || !t.start || !t.duration) throw new Error('T√¢che invalide: ' + t.id); if (!t.deps) t.deps = []; if (!t.budget) t.budget = 0; if (!t.ref) t.ref = ''; });
    p.scenarios.forEach(sc => { if (!sc.id || !sc.name) throw new Error('Sc√©nario invalide'); if (!sc.taskIds) sc.taskIds = []; });
    project = p;
    if (!project.activeScenario) project.activeScenario = project.scenarios[0].id;
    nextTaskId  = Math.max(...project.tasks.map(t  => t.id),  nextTaskId  - 1) + 1;
    nextGroupId = Math.max(...project.groups.map(g => g.id), nextGroupId - 1) + 1;
    errEl.classList.remove('show');
    render();
  } catch(e) {
    errEl.textContent = '‚ö† ' + e.message;
    errEl.classList.add('show');
  }
}

document.getElementById('json-editor').addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); applyJson(); }
  if (e.key === 'Tab') {
    e.preventDefault();
    const ta = e.target, s = ta.selectionStart, end = ta.selectionEnd;
    ta.value = ta.value.substring(0, s) + '  ' + ta.value.substring(end);
    ta.selectionStart = ta.selectionEnd = s + 2;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  const btn = document.getElementById('theme-btn');
  btn.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  btn.title = isLight ? 'Passer en mode nuit' : 'Passer en mode jour';
  localStorage.setItem('gantt-theme', isLight ? 'light' : 'dark');
}

(function() {
  if (localStorage.getItem('gantt-theme') === 'light') {
    document.body.classList.add('light');
    window.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('theme-btn');
      if (btn) { btn.textContent = '‚òÄÔ∏è'; btn.title = 'Passer en mode nuit'; }
    });
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let resizeTimer;
window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(render, 120); });

render();
</script>
</body>
</html>
